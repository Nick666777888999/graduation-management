<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>畢業資料管理系統 - API版本</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* 這裡包含所有CSS樣式 - 為了簡潔已省略，實際使用時需要包含 */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    /* ... 其他所有樣式 ... */
  </style>
</head>
<body>
  <!-- 登入頁面 -->
  <div id="login-page" class="login-container">
    <div class="login-box">
      <div class="login-header">
        <h1>畢業管理系統 - API版本</h1>
        <p>全新後端API，數據永久保存</p>
      </div>
      
      <form id="login-form">
        <div class="form-group">
          <label for="login-username">帳號</label>
          <input type="text" id="login-username" placeholder="請輸入帳號" required>
        </div>
        
        <div class="form-group">
          <label for="login-password">密碼</label>
          <input type="password" id="login-password" placeholder="請輸入密碼" required>
        </div>
        
        <button type="submit" class="btn btn-primary" id="login-btn">
          <span id="login-btn-text">登入</span>
          <div id="login-loading" class="loading" style="display: none;"></div>
        </button>
        
        <div id="login-error" class="error-message"></div>
      </form>
      
      <div class="login-links">
        <a onclick="showRegister()">註冊帳號</a>
        <a onclick="showAdminLogin()">管理員登入</a>
        <a href="/">返回舊版本</a>
      </div>
    </div>
  </div>

  <!-- 註冊頁面 -->
  <div id="register-page" class="login-container" style="display: none;">
    <!-- 註冊表單內容 -->
  </div>

  <!-- 主應用程式 -->
  <div id="app" class="app-container">
    <!-- 頭部、導航、內容區域 -->
    <div class="header">
      <h1>畢業資料管理系統 - API版本</h1>
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">U</div>
        <span id="user-name">用戶</span>
        <button class="btn btn-secondary" onclick="logout()" style="padding: 8px 15px;">登出</button>
      </div>
    </div>
    
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="loadContent('dashboard')">儀表板</button>
      <button class="nav-tab" onclick="loadContent('chat')">聊天室</button>
      <button class="nav-tab" onclick="loadContent('friends')">好友系統</button>
      <button class="nav-tab" onclick="loadContent('questions')">問題討論</button>
      <button class="nav-tab" onclick="loadContent('students')">學生資料</button>
      <button class="nav-tab" onclick="loadContent('announcements')">系統公告</button>
      <button class="nav-tab" id="admin-tab" style="display: none;" onclick="loadContent('admin')">管理後台</button>
    </div>
    
    <div class="content-area">
      <!-- 各功能區域 -->
      <div id="dashboard-content" class="content-section active">
        <h2>系統儀表板</h2>
        <div id="dashboard-stats"></div>
      </div>
      
      <div id="chat-content" class="content-section">
        <h2>即時聊天室</h2>
        <div class="chat-container">
          <div class="chat-messages" id="chat-messages"></div>
          <div class="chat-input">
            <input type="text" id="chat-input" placeholder="輸入訊息...">
            <button onclick="sendMessage()">發送</button>
          </div>
        </div>
      </div>
      
      <!-- 其他功能區域 -->
      <div id="friends-content" class="content-section">
        <h2>好友系統</h2>
        <div id="friends-container"></div>
      </div>
      
      <div id="questions-content" class="content-section">
        <h2>問題討論區</h2>
        <div id="questions-container"></div>
      </div>
      
      <div id="students-content" class="content-section">
        <h2>學生資料管理</h2>
        <div id="students-container"></div>
      </div>
      
      <div id="announcements-content" class="content-section">
        <h2>系統公告</h2>
        <div id="announcements-container"></div>
      </div>
      
      <div id="admin-content" class="content-section">
        <h2>管理後台</h2>
        <div id="admin-container"></div>
      </div>
    </div>
  </div>

  <script>
    // 全局變量和配置
    let currentUser = null;
    let isAdmin = false;
    const API_BASE = '';

    // API 調用函數
    async function apiCall(endpoint, data = null, method = 'POST') {
      try {
        const options = {
          method: method,
          headers: {'Content-Type': 'application/json'},
          credentials: 'include'
        };
        if (data && method !== 'GET') options.body = JSON.stringify(data);
        
        const response = await fetch(`${API_BASE}/api/${endpoint}`, options);
        const result = await response.json();
        
        if (!result.success && result.message) {
          showNotification(result.message, 'error');
        }
        return result;
      } catch (error) {
        console.error('API錯誤:', error);
        showNotification('網路錯誤，請稍後再試', 'error');
        return {success: false, message: '網路錯誤'};
      }
    }

    // 用戶系統
    async function login(username, password) {
      const result = await apiCall('login', {username, password});
      if (result.success) {
        currentUser = result.user;
        isAdmin = result.user.isAdmin;
        showApp();
        showNotification(`歡迎回來，${currentUser.name}！`, 'success');
      }
      return result;
    }

    async function register(userData) {
      return await apiCall('users', userData);
    }

    async function logout() {
      const result = await apiCall('logout', {}, 'POST');
      if (result.success) {
        currentUser = null;
        showLoginPage();
        showNotification('已成功登出', 'success');
      }
    }

    // 聊天系統
    async function loadChatMessages() {
      const result = await apiCall('messages', null, 'GET');
      if (result.success) {
        displayChatMessages(result);
      }
    }

    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) return;

      const result = await apiCall('messages', {
        sender: currentUser.username,
        text: text,
        sender_name: currentUser.name,
        is_admin: isAdmin
      });

      if (result.success) {
        input.value = '';
        await loadChatMessages();
      }
    }

    // 好友系統
    async function loadFriends() {
      const result = await apiCall('friends', null, 'GET');
      if (result.success) {
        displayFriends(result.friends, result.requests);
      }
    }

    async function sendFriendRequest(username) {
      const result = await apiCall('friends', {username});
      if (result.success) {
        showNotification('好友申請已發送', 'success');
        await loadFriends();
      }
    }

    // 問題討論系統
    async function loadQuestions() {
      const result = await apiCall('questions', null, 'GET');
      if (result.success) {
        displayQuestions(result);
      }
    }

    async function postQuestion(questionData) {
      const result = await apiCall('questions', {
        ...questionData,
        author: currentUser.username,
        author_name: currentUser.name
      });
      
      if (result.success) {
        showNotification('問題發布成功', 'success');
        await loadQuestions();
      }
      return result;
    }

    // 學生資料系統
    async function loadStudentData(level = 'all') {
      const result = await apiCall(`student-data?level=${level}`, null, 'GET');
      if (result.success) {
        displayStudentData(result, level);
      }
    }

    async function submitStudentData(studentData) {
      const result = await apiCall('student-data', {
        ...studentData,
        submitted_by: currentUser.username
      });
      
      if (result.success) {
        showNotification('學生資料提交成功', 'success');
        await loadStudentData(studentData.level);
      }
      return result;
    }

    // 公告系統
    async function loadAnnouncements() {
      const result = await apiCall('announcements', null, 'GET');
      if (result.success) {
        displayAnnouncements(result);
      }
    }

    async function postAnnouncement(announcementData) {
      const result = await apiCall('announcements', {
        ...announcementData,
        author_name: currentUser.name
      });
      
      if (result.success) {
        showNotification('公告發布成功', 'success');
        await loadAnnouncements();
      }
      return result;
    }

    // 管理員功能
    async function loadAdminData() {
      if (!isAdmin) return;
      
      const [users, messages, questions, students] = await Promise.all([
        apiCall('users', null, 'GET'),
        apiCall('messages', null, 'GET'),
        apiCall('questions', null, 'GET'),
        apiCall('student-data', null, 'GET')
      ]);

      displayAdminData({users, messages, questions, students});
    }

    // 頁面顯示控制
    function showLoginPage() {
      document.getElementById('login-page').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
    }

    function showApp() {
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      updateUserInterface();
      loadInitialData();
    }

    function updateUserInterface() {
      if (currentUser) {
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-avatar').textContent = currentUser.name.charAt(0);
        
        if (isAdmin) {
          document.getElementById('admin-tab').style.display = 'block';
        }
      }
    }

    async function loadInitialData() {
      await loadChatMessages();
      await loadFriends();
      await loadQuestions();
      await loadStudentData();
      await loadAnnouncements();
      updateDashboard();
    }

    function updateDashboard() {
      // 更新儀表板統計信息
      const stats = document.getElementById('dashboard-stats');
      stats.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
          <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
            <h3 style="color: #667eea;">歡迎使用</h3>
            <p>API版本系統</p>
            <p><strong>${currentUser.name}</strong></p>
          </div>
          <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
            <h3 style="color: #667eea;">數據存儲</h3>
            <p>後端數據庫</p>
            <p style="color: #27ae60;">永久保存</p>
          </div>
        </div>
      `;
    }

    function loadContent(section) {
      // 隱藏所有內容區域
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // 更新導航標籤
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // 顯示目標內容
      document.getElementById(`${section}-content`).classList.add('active');
      
      // 加載對應數據
      switch(section) {
        case 'chat': loadChatMessages(); break;
        case 'friends': loadFriends(); break;
        case 'questions': loadQuestions(); break;
        case 'students': loadStudentData(); break;
        case 'announcements': loadAnnouncements(); break;
        case 'admin': loadAdminData(); break;
        case 'dashboard': updateDashboard(); break;
      }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 綁定表單事件
      document.getElementById('login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        await login(username, password);
      });

      // 其他初始化代碼...
    });

    // 工具函數
    function showNotification(message, type = 'info') {
      // 通知顯示實現
      console.log(`${type}: ${message}`);
    }

    function displayChatMessages(messages) {
      // 聊天訊息顯示實現
    }

    function displayFriends(friends, requests) {
      // 好友列表顯示實現
    }

    function displayQuestions(questions) {
      // 問題列表顯示實現
    }

    function displayStudentData(students, level) {
      // 學生資料顯示實現
    }

    function displayAnnouncements(announcements) {
      // 公告顯示實現
    }

    function displayAdminData(data) {
      // 管理員數據顯示實現
    }
  </script>
</body>
</html>