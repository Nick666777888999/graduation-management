<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç•¢æ¥­è³‡æ–™ç®¡ç†ç³»çµ±</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; 
      background-color: #f0f8ff;
    }
    
    /* é ‚éƒ¨å°èˆªæ¬„ */
    .top-bar { 
      background: linear-gradient(135deg, #008B8B, #20B2AA); 
      color: white; 
      padding: 12px 20px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    
    .top-bar .title {
      font-size: 1.4rem;
      font-weight: bold;
    }
    
    .top-bar .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .top-bar .admin-badge {
      background: #ff9800;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .top-bar .admin-tools {
      position: relative;
    }
    
    .admin-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      min-width: 200px;
      display: none;
      z-index: 1001;
    }
    
    .admin-menu.show {
      display: block;
    }
    
    .admin-menu-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      color: #333;
      transition: background 0.3s;
    }
    
    .admin-menu-item:hover {
      background: #f5f5f5;
    }
    
    .admin-menu-item i {
      margin-right: 8px;
      width: 20px;
      text-align: center;
    }
    
    /* å´é‚Šæ¬„ - éŸ¿æ‡‰å¼è¨­è¨ˆ */
    .side-bar { 
      background: linear-gradient(to bottom, #008B8B, #20B2AA); 
      width: 250px; 
      height: 100vh; 
      position: fixed; 
      top: 0; 
      left: 0; 
      padding-top: 70px; 
      color: white; 
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      z-index: 999;
      transition: all 0.3s ease;
      overflow-y: auto;
    }
    
    .side-bar button { 
      display: flex; 
      align-items: center;
      width: 100%; 
      background: none; 
      border: none; 
      color: white; 
      padding: 15px 20px; 
      text-align: left; 
      cursor: pointer; 
      font-size: 16px;
      transition: all 0.3s;
      border-left: 4px solid transparent;
    }
    
    .side-bar button i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
      font-size: 18px;
    }
    
    .side-bar button:hover { 
      background-color: rgba(255,255,255,0.1); 
      border-left: 4px solid #ffeb3b;
    }
    
    .side-bar button.active {
      background-color: rgba(255,255,255,0.15);
      border-left: 4px solid #ffeb3b;
    }
    
    /* ä¸»å…§å®¹å€åŸŸ */
    .content { 
      margin-left: 250px; 
      padding: 80px 30px 30px; 
      background-color: #f5f5f5; 
      min-height: 100vh; 
      transition: margin-left 0.3s ease;
    }
    
    .content-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      padding: 25px;
      margin-bottom: 25px;
    }
    
    .content-card h2 {
      color: #008B8B;
      margin-top: 0;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }
    
    /* å…¬å‘Šæ¨£å¼ */
    .announcement { 
      background: white; 
      margin-bottom: 20px; 
      padding: 20px; 
      border-left: 5px solid #008B8B; 
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: relative;
    }
    
    .announcement h3 { 
      margin-top: 0; 
      color: #008B8B;
    }
    
    .announcement-actions {
      position: absolute;
      top: 15px;
      right: 15px;
    }
    
    .delete-announcement {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .delete-announcement:hover {
      background: #c0392b;
    }
    
    /* ç™»å…¥/è¨»å†Šé é¢ */
    .login-wrapper { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      height: 100vh; 
      background: linear-gradient(135deg, #008B8B, #20B2AA);
    }
    
    .login-box, .register-box, .admin-login-box { 
      background: white; 
      padding: 30px; 
      border-radius: 15px; 
      width: 380px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .login-box h2, .register-box h2, .admin-login-box h2 {
      text-align: center;
      color: #008B8B;
      margin-top: 0;
    }
    
    .login-box input, .register-box input, .admin-login-box input { 
      width: 100%; 
      padding: 12px 15px; 
      margin: 10px 0; 
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border 0.3s;
    }
    
    .login-box input:focus, .register-box input:focus, .admin-login-box input:focus {
      border-color: #008B8B;
      outline: none;
      box-shadow: 0 0 0 2px rgba(0,139,139,0.2);
    }
    
    .login-box button, .register-box button, .admin-login-box button { 
      width: 100%; 
      padding: 12px; 
      background: linear-gradient(to right, #008B8B, #20B2AA); 
      color: white; 
      border: none; 
      border-radius: 8px;
      cursor: pointer; 
      margin-top: 10px; 
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .login-box button:hover, .register-box button:hover, .admin-login-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,139,139,0.3);
    }
    
    .error { 
      color: #e74c3c; 
      text-align: center; 
      margin: 10px 0;
      font-weight: bold;
    }
    
    /* èŠå¤©å®¤æ¨£å¼ - ä¿®æ”¹ç‚ºLineé¢¨æ ¼ */
    .chat-message { 
      background: white; 
      padding: 15px; 
      margin: 15px 0; 
      border-radius: 12px; 
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      max-width: 70%;
      word-wrap: break-word;
    }
    
    .chat-message.own {
      background: #dcf8c6;
      margin-left: auto;
      border-bottom-right-radius: 5px;
    }
    
    .chat-message.other {
      background: white;
      margin-right: auto;
      border-bottom-left-radius: 5px;
    }
    
    .chat-message.admin {
      border-left: 5px solid #ff9800;
      background: #fff9e6;
      max-width: 90%;
      margin: 15px auto;
    }
    
    .chat-message .time { 
      font-size: 12px; 
      color: #888; 
      text-align: right; 
      margin-top: 5px;
    }
    
    .chat-message .sender-name {
      font-weight: bold;
      color: #008B8B;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .chat-media {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .chat-input { 
      display: flex; 
      margin-top: 15px; 
      gap: 10px;
    }
    
    .chat-input input { 
      flex: 1; 
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .chat-input button { 
      padding: 12px 20px; 
      background: linear-gradient(to right, #008B8B, #20B2AA); 
      color: white; 
      border: none; 
      border-radius: 8px;
      cursor: pointer; 
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .chat-input button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,139,139,0.3);
    }
    
    .media-upload-btn {
      background: #9b59b6 !important;
    }
    
    .avatar { 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      object-fit: cover; 
      margin-right: 10px;
      border: 2px solid #008B8B;
    }
    
    /* è³‡æ–™è¡¨æ ¼æ¨£å¼ */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .data-table th, .data-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    .data-table th {
      background-color: #f5f5f5;
      color: #008B8B;
      font-weight: bold;
    }
    
    .data-table tr:hover {
      background-color: #f9f9f9;
    }
    
    .delete-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .delete-btn:hover {
      background: #c0392b;
    }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 1200px) {
      .side-bar {
        width: 220px;
      }
      .content {
        margin-left: 220px;
      }
    }
    
    @media (max-width: 992px) {
      .side-bar {
        width: 200px;
      }
      .content {
        margin-left: 200px;
        padding: 70px 20px 20px;
      }
    }
    
    @media (max-width: 768px) {
      .side-bar {
        width: 70px;
      }
      
      .side-bar button span {
        display: none;
      }
      
      .side-bar button i {
        margin-right: 0;
        font-size: 20px;
      }
      
      .content {
        margin-left: 70px;
        padding: 70px 15px 15px;
      }
      
      .login-box, .register-box, .admin-login-box {
        width: 90%;
        max-width: 350px;
      }
      
      .chat-message {
        max-width: 85%;
      }
    }
    
    @media (max-width: 576px) {
      .side-bar {
        width: 60px;
      }
      
      .content {
        margin-left: 60px;
        padding: 70px 10px 10px;
      }
      
      .top-bar .title {
        font-size: 1.1rem;
      }
      
      .top-bar .user-info {
        font-size: 0.9rem;
      }
    }
    
    /* çµ±è¨ˆå¡ç‰‡ */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    
    .stat-card i {
      font-size: 2.5rem;
      color: #008B8B;
      margin-bottom: 10px;
    }
    
    .stat-card .number {
      font-size: 2rem;
      font-weight: bold;
      color: #008B8B;
    }
    
    .stat-card .label {
      color: #666;
      margin-top: 5px;
    }
    
    /* è¡¨å–®æ¨£å¼ */
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    
    .form-control {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-control:focus {
      border-color: #008B8B;
      outline: none;
      box-shadow: 0 0 0 2px rgba(0,139,139,0.2);
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      margin: 15px 0;
    }
    
    .checkbox-group input {
      margin-right: 10px;
    }
    
    /* é€šçŸ¥æ¨£å¼ */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      z-index: 1100;
      transform: translateX(150%);
      transition: transform 0.4s;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: #2ecc71;
    }
    
    .notification.error {
      background: #e74c3c;
    }
    
    .notification.info {
      background: #3498db;
    }
    
    /* å€‹äººç°¡ä»‹å½ˆçª— */
    .profile-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    
    .profile-modal-content {
      background: white;
      border-radius: 15px;
      width: 500px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }
    
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 20px;
      border: 3px solid #008B8B;
    }
    
    .profile-info h3 {
      margin: 0 0 5px 0;
      color: #008B8B;
    }
    
    .profile-info p {
      margin: 0;
      color: #666;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #888;
    }
    
    .close-modal:hover {
      color: #333;
    }
    
    /* å€‹äººä»‹ç´¹å€åŸŸ */
    .personal-intro {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      border-left: 4px solid #008B8B;
    }
    
    .personal-intro h4 {
      margin-top: 0;
      color: #008B8B;
    }
    
    .intro-text {
      white-space: pre-line;
      line-height: 1.5;
    }
    
    .edit-intro-btn {
      background: #008B8B;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .edit-intro-btn:hover {
      background: #006666;
    }
    
    /* æœå°‹å€åŸŸ */
    .search-box {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .search-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .search-form .form-group {
      flex: 1;
      min-width: 200px;
      margin-bottom: 0;
    }
    
    .search-btn {
      background: #008B8B;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .search-btn:hover {
      background: #006666;
    }
    
    /* æ©Ÿå™¨äººé©—è­‰ */
    .captcha-box {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
    }
    
    .captcha-checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
    }
    
    .captcha-checkbox input {
      width: 20px;
      height: 20px;
    }

    /* å­¸ç”Ÿè³‡æ–™å¡ç‰‡æ¨£å¼ */
    .student-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      padding: 20px;
      margin-bottom: 20px;
      border-left: 5px solid #008B8B;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .student-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .student-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }

    .student-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 20px;
      border: 3px solid #008B8B;
    }

    .student-basic-info h3 {
      margin: 0 0 5px 0;
      color: #008B8B;
      font-size: 1.3rem;
    }

    .student-basic-info p {
      margin: 2px 0;
      color: #666;
      font-size: 0.9rem;
    }

    .student-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .detail-group {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      border-left: 3px solid #20B2AA;
    }

    .detail-group h4 {
      margin: 0 0 8px 0;
      color: #008B8B;
      font-size: 0.95rem;
    }

    .detail-group p {
      margin: 0;
      color: #555;
      line-height: 1.4;
    }

    .student-intro {
      background: #e8f4f8;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border-left: 3px solid #3498db;
    }

    .student-intro h4 {
      margin: 0 0 8px 0;
      color: #2980b9;
    }

    .student-intro p {
      margin: 0;
      color: #2c3e50;
      line-height: 1.5;
    }

    .student-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: flex-end;
    }

    .approve-btn {
      background: #2ecc71;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .approve-btn:hover {
      background: #27ae60;
    }

    .reject-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .reject-btn:hover {
      background: #c0392b;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-left: 10px;
    }

    .status-pending {
      background: #f39c12;
      color: white;
    }

    .status-approved {
      background: #2ecc71;
      color: white;
    }

    .status-rejected {
      background: #e74c3c;
      color: white;
    }

    /* å­—æ•¸è¨ˆæ•¸å™¨ */
    .char-counter {
      text-align: right;
      font-size: 0.8rem;
      color: #666;
      margin-top: 5px;
    }

    .char-counter.warning {
      color: #e74c3c;
    }

    /* å¯©æ ¸é é¢æ¨£å¼ */
    .filter-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }

    .filter-tab {
      background: #f5f5f5;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-tab.active {
      background: #008B8B;
      color: white;
    }

    .filter-tab:hover {
      background: #20B2AA;
      color: white;
    }

    /* å¥½å‹ç³»çµ±æ¨£å¼ - Instagramé¢¨æ ¼ */
    .friend-section {
      margin-bottom: 25px;
    }

    .friend-section-title {
      background: linear-gradient(135deg, #008B8B, #20B2AA);
      color: white;
      padding: 12px 20px;
      border-radius: 10px 10px 0 0;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .friend-container {
      background: white;
      border-radius: 0 0 10px 10px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }

    .friend-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .friend-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      padding: 20px;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .friend-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      border-color: #008B8B;
    }

    .friend-card.online::before {
      content: '';
      position: absolute;
      top: 15px;
      right: 15px;
      width: 12px;
      height: 12px;
      background: #2ecc71;
      border-radius: 50%;
      border: 2px solid white;
    }

    .friend-card.offline::before {
      content: '';
      position: absolute;
      top: 15px;
      right: 15px;
      width: 12px;
      height: 12px;
      background: #95a5a6;
      border-radius: 50%;
      border: 2px solid white;
    }

    .friend-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .friend-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 20px;
      border: 3px solid #008B8B;
    }

    .friend-info h4 {
      margin: 0 0 8px 0;
      color: #2c3e50;
      font-size: 1.2rem;
    }

    .friend-info p {
      margin: 0;
      color: #7f8c8d;
      font-size: 0.95rem;
    }

    .friend-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-size: 0.85rem;
      color: #666;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .friend-actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .friend-action-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .friend-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
    }

    .friend-action-btn.chat {
      background: #2ecc71;
    }

    .friend-action-btn.remove {
      background: #e74c3c;
    }

    /* å¥½å‹ç”³è«‹å¡ç‰‡ */
    .friend-request-card {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      border: 2px solid #ffd43b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .request-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    /* ç§è¨ŠèŠå¤©å®¤æ¨£å¼ */
    .private-chat-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: #f9f9f9;
    }

    .private-message {
      background: white;
      padding: 12px 16px;
      margin: 8px 0;
      border-radius: 18px;
      max-width: 70%;
      word-wrap: break-word;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .private-message.own {
      background: #dcf8c6;
      margin-left: auto;
      border-bottom-right-radius: 5px;
    }

    .private-message.other {
      background: white;
      margin-right: auto;
      border-bottom-left-radius: 5px;
    }

    .private-message .time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 5px;
      text-align: right;
    }

    .private-message .sender {
      font-weight: bold;
      color: #008B8B;
      margin-bottom: 5px;
      font-size: 13px;
    }

    /* é¡Œç›®è¨è«–å€æ¨£å¼ */
    .question-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      padding: 20px;
      margin-bottom: 20px;
      border-left: 5px solid #3498db;
    }

    .question-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .question-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 15px;
    }

    .question-meta h4 {
      margin: 0 0 5px 0;
      color: #2c3e50;
    }

    .question-meta .grade-subject {
      color: #7f8c8d;
      font-size: 0.9rem;
    }

    .question-content {
      margin-bottom: 15px;
    }

    .question-text {
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .question-image {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .question-actions {
      display: flex;
      gap: 15px;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }

    .action-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: color 0.3s;
    }

    .action-btn:hover {
      color: #008B8B;
    }

    .action-btn.liked {
      color: #e74c3c;
    }

    .comments-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .comment {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .comment-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .comment-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }

    .comment-content {
      margin-left: 40px;
    }

    .add-comment {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .add-comment input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 20px;
    }

    /* ç™¼è¡¨é¡Œç›®æµ®å‹•æŒ‰éˆ• */
    .floating-action-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #008B8B, #20B2AA);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 1000;
      transition: all 0.3s;
    }

    .floating-action-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 25px rgba(0,0,0,0.4);
    }

    /* ç™¼è¡¨é¡Œç›®è¡¨å–® */
    .question-form-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .question-form-content {
      background: white;
      border-radius: 15px;
      width: 600px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .subject-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
    }

    .subject-tag {
      background: #e8f4f8;
      border: 1px solid #3498db;
      border-radius: 15px;
      padding: 5px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .subject-tag:hover {
      background: #3498db;
      color: white;
    }

    .subject-tag.selected {
      background: #3498db;
      color: white;
    }

    /* ç©ºç‹€æ…‹ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #bdc3c7;
    }

    .empty-state h3 {
      margin: 0 0 10px 0;
      color: #95a5a6;
    }
  </style>
</head>
<body>
  <!-- ç™»å…¥é é¢ -->
  <div class="login-wrapper" id="login-screen">
    <div class="login-box">
      <h2><i class="fas fa-graduation-cap"></i> ç•¢æ¥­è³‡æ–™ç®¡ç†ç³»çµ±</h2>
      <div class="error" id="error-msg"></div>
      <input type="text" id="username" placeholder="å¸³è™Ÿ">
      <input type="password" id="password" placeholder="å¯†ç¢¼">
      <button onclick="login()"><i class="fas fa-sign-in-alt"></i> ç™»å…¥</button>
      <button onclick="showRegister()"><i class="fas fa-user-plus"></i> è¨»å†Š</button>
      <button onclick="showAdminLogin()" style="background: #ff9800;"><i class="fas fa-user-shield"></i> ç®¡ç†å“¡ç™»å…¥</button>
    </div>
  </div>

  <!-- ç®¡ç†å“¡ç™»å…¥é é¢ -->
  <div class="login-wrapper" id="admin-login-screen" style="display:none;">
    <div class="admin-login-box">
      <h2><i class="fas fa-user-shield"></i> ç®¡ç†å“¡ç™»å…¥</h2>
      <div class="error" id="admin-error-msg"></div>
      <input type="text" id="admin-username" placeholder="ç®¡ç†å“¡å¸³è™Ÿ">
      <input type="password" id="admin-password" placeholder="ç®¡ç†å“¡å¯†ç¢¼">
      
      <div class="captcha-box">
        <div class="captcha-checkbox" onclick="toggleCaptcha()">
          <input type="checkbox" id="captcha-check">
          <label for="captcha-check">æˆ‘ä¸æ˜¯æ©Ÿå™¨äºº</label>
        </div>
      </div>
      
      <button onclick="adminLogin()"><i class="fas fa-sign-in-alt"></i> ç®¡ç†å“¡ç™»å…¥</button>
      <button onclick="hideAdminLogin()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
    </div>
  </div>

  <!-- è¨»å†Šé é¢ -->
  <div class="login-wrapper" id="register-screen" style="display:none;">
    <div class="register-box">
      <h2><i class="fas fa-user-plus"></i> è¨»å†Šå¸³è™Ÿ</h2>
      <input type="text" id="reg-name" placeholder="å§“å">
      <input type="text" id="reg-school" placeholder="å°±è®€å­¸æ ¡">
      <input type="email" id="reg-email" placeholder="Gmail">
      <input type="text" id="reg-username" placeholder="å¸³è™Ÿ">
      <input type="password" id="reg-password" placeholder="å¯†ç¢¼">
      <textarea id="reg-intro" placeholder="å€‹äººä»‹ç´¹ (è‡³å°‘50å­—)" class="form-control" rows="3" oninput="countChars('reg-intro', 'reg-char-count')"></textarea>
      <div id="reg-char-count" class="char-counter">0/50</div>
      <button onclick="register()"><i class="fas fa-check"></i> é€å‡º</button>
      <button onclick="hideRegister()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
    </div>
  </div>

  <!-- ä¸»ç³»çµ±é é¢ -->
  <div id="main-screen" style="display:none;">
    <div class="top-bar">
      <div class="title"><i class="fas fa-graduation-cap"></i> ç•¢æ¥­è³‡æ–™ç®¡ç†ç³»çµ±</div>
      <div class="user-info">
        <span id="current-user-name">ä½¿ç”¨è€…</span>
        <span id="admin-badge" class="admin-badge" style="display:none;">ç®¡ç†å“¡</span>
        <span onclick="showProfileModal()" style="cursor:pointer;"><i class="fas fa-user-circle"></i> å€‹äººç°¡ä»‹</span>
        <div class="admin-tools" id="admin-tools" style="display:none;">
          <span onclick="toggleAdminMenu()" style="cursor:pointer;"><i class="fas fa-cog"></i> ç®¡ç†å·¥å…·</span>
          <div class="admin-menu" id="admin-menu">
            <div class="admin-menu-item" onclick="openSystemEditor()">
              <i class="fas fa-code"></i> ç³»çµ±ç·¨è¼¯å™¨
            </div>
            <div class="admin-menu-item" onclick="loadContent('system_config')">
              <i class="fas fa-cogs"></i> ç³»çµ±è¨­å®š
            </div>
            <div class="admin-menu-item" onclick="backupSystem()">
              <i class="fas fa-download"></i> å‚™ä»½ç³»çµ±
            </div>
            <div class="admin-menu-item" onclick="restoreSystem()">
              <i class="fas fa-upload"></i> é‚„åŸç³»çµ±
            </div>
          </div>
        </div>
        <span onclick="logout()" style="cursor:pointer; margin-left:15px;"><i class="fas fa-sign-out-alt"></i> ç™»å‡º</span>
      </div>
    </div>
    <div class="side-bar">
      <button onclick="loadContent('dashboard')" class="active"><i class="fas fa-tachometer-alt"></i> <span>å„€è¡¨æ¿</span></button>
      <button onclick="loadContent('announcements')"><i class="fas fa-bullhorn"></i> <span>ç³»çµ±å…¬å‘Š</span></button>
      <button onclick="loadContent('primary')"><i class="fas fa-child"></i> <span>åœ‹å°å­¸ç”Ÿ</span></button>
      <button onclick="loadContent('junior')"><i class="fas fa-user-graduate"></i> <span>åœ‹ä¸­å­¸ç”Ÿ</span></button>
      <button onclick="loadContent('high')"><i class="fas fa-user-tie"></i> <span>é«˜ä¸­å­¸ç”Ÿ</span></button>
      <button onclick="loadContent('data-entry')"><i class="fas fa-edit"></i> <span>è³‡æ–™å¡«å¯«</span></button>
      <button onclick="loadContent('other')"><i class="fas fa-users"></i> <span>å…¶ä»–å¹´ç´š</span></button>
      <button onclick="loadContent('search')"><i class="fas fa-search"></i> <span>è³‡æ–™æŸ¥è©¢</span></button>
      <button onclick="loadContent('review')" id="review-btn" style="display:none;"><i class="fas fa-clipboard-check"></i> <span>è³‡æ–™å¯©æ ¸</span></button>
      <button onclick="loadContent('statistics')" id="statistics-btn" style="display:none;"><i class="fas fa-chart-bar"></i> <span>æ•¸æ“šçµ±è¨ˆ</span></button>
      <button onclick="loadContent('chat')"><i class="fas fa-comments"></i> <span>å…«å¦èŠå¤©å®¤</span></button>
      <button onclick="loadContent('questions')"><i class="fas fa-question-circle"></i> <span>é¡Œç›®è¨è«–å€</span></button>
      <button onclick="loadContent('friends')"><i class="fas fa-user-friends"></i> <span>å¥½å‹ç³»çµ±</span></button>
    </div>
    <div class="content" id="content-area">
      <!-- å…§å®¹å°‡ç”±JavaScriptå‹•æ…‹è¼‰å…¥ -->
    </div>
  </div>

  <!-- å€‹äººç°¡ä»‹å½ˆçª— -->
  <div id="profile-modal" class="profile-modal">
    <div class="profile-modal-content">
      <button class="close-modal" onclick="closeProfileModal()">&times;</button>
      <div class="profile-header">
        <img id="profile-avatar" src="https://ui-avatars.com/api/?name=ä½¿ç”¨è€…&background=008B8B&color=fff" class="profile-avatar">
        <div class="profile-info">
          <h3 id="profile-name">ä½¿ç”¨è€…åç¨±</h3>
          <p id="profile-school">å­¸æ ¡åç¨±</p>
          <p id="profile-email">email@example.com</p>
        </div>
      </div>
      
      <div class="form-group">
        <label>å€‹äººä»‹ç´¹ (è‡³å°‘50å­—)</label>
        <textarea id="profile-intro" class="form-control" rows="4" placeholder="è«‹è¼¸å…¥æ‚¨çš„å€‹äººä»‹ç´¹..." oninput="countChars('profile-intro', 'profile-char-count')"></textarea>
        <div id="profile-char-count" class="char-counter">0/50</div>
      </div>
      
      <div class="form-group">
        <label>åŒ¿åé¡¯ç¤ºåç¨± (èŠå¤©å®¤ä½¿ç”¨)</label>
        <input type="text" id="profile-anonymous" class="form-control" placeholder="è¼¸å…¥åŒ¿åé¡¯ç¤ºåç¨±">
      </div>
      
      <div class="form-group">
        <label>å€‹æ€§ç‰¹è³ª</label>
        <input type="text" id="profile-personality" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ´»æ½‘é–‹æœ—ã€ç´°å¿ƒè² è²¬">
      </div>
      
      <div class="form-group">
        <label>èˆˆè¶£æ„›å¥½</label>
        <input type="text" id="profile-hobbies" class="form-control" placeholder="ä¾‹å¦‚ï¼šé–±è®€ã€é‹å‹•ã€éŸ³æ¨‚">
      </div>
      
      <div class="form-group">
        <label>å–œæ­¡çš„äº‹ç‰©</label>
        <input type="text" id="profile-likes" class="form-control" placeholder="ä¾‹å¦‚ï¼šè²“å’ªã€æ—…è¡Œã€ç¾é£Ÿ">
      </div>
      
      <div class="form-group">
        <label>ä¸Šå‚³é ­åƒ</label>
        <input type="file" id="avatar-upload" class="form-control" accept="image/*">
      </div>
      
      <div class="form-group">
        <label>è®Šæ›´å¯†ç¢¼</label>
        <input type="password" id="profile-current-password" class="form-control" placeholder="ç•¶å‰å¯†ç¢¼">
        <input type="password" id="profile-new-password" class="form-control" placeholder="æ–°å¯†ç¢¼">
        <input type="password" id="profile-confirm-password" class="form-control" placeholder="ç¢ºèªæ–°å¯†ç¢¼">
      </div>
      
      <button onclick="updateProfile()" class="login-box button" style="width:100%;"><i class="fas fa-save"></i> å„²å­˜è®Šæ›´</button>
    </div>
  </div>

  <!-- ç™¼è¡¨é¡Œç›®è¡¨å–® -->
  <div id="question-form-modal" class="question-form-modal">
    <div class="question-form-content">
      <button class="close-modal" onclick="closeQuestionForm()">&times;</button>
      <h2><i class="fas fa-question-circle"></i> ç™¼è¡¨å•é¡Œ</h2>
      
      <div class="form-group">
        <label>è«‹ç™¼è¡¨ä½ ä¸æœƒçš„å•é¡Œ (0-150å­—)</label>
        <textarea id="question-text" class="form-control" rows="4" placeholder="è«‹è©³ç´°æè¿°æ‚¨çš„å•é¡Œ..." maxlength="150" oninput="countChars('question-text', 'question-char-count')"></textarea>
        <div id="question-char-count" class="char-counter">0/150</div>
      </div>
      
      <div class="form-group">
        <label>æ·»åŠ ç…§ç‰‡ (é¸å¡«)</label>
        <input type="file" id="question-image" class="form-control" accept="image/*">
      </div>
      
      <div class="form-group">
        <label>ç§‘ç›®</label>
        <div class="subject-tags" id="subject-tags">
          <span class="subject-tag" data-subject="åœ‹æ–‡">åœ‹æ–‡</span>
          <span class="subject-tag" data-subject="æˆèª">æˆèª</span>
          <span class="subject-tag" data-subject="ä½œæ–‡">ä½œæ–‡</span>
          <span class="subject-tag" data-subject="è‹±æ–‡">è‹±æ–‡</span>
          <span class="subject-tag" data-subject="æ•¸å­¸">æ•¸å­¸</span>
          <span class="subject-tag" data-subject="ç¤¾æœƒ">ç¤¾æœƒ</span>
          <span class="subject-tag" data-subject="æ­·å²">æ­·å²</span>
          <span class="subject-tag" data-subject="åœ°ç†">åœ°ç†</span>
          <span class="subject-tag" data-subject="ç”Ÿç‰©">ç”Ÿç‰©</span>
          <span class="subject-tag" data-subject="åŒ–å­¸">åŒ–å­¸</span>
          <span class="subject-tag" data-subject="ç‰©ç†">ç‰©ç†</span>
          <span class="subject-tag" data-subject="å…¶ä»–ç§‘ç›®">å…¶ä»–ç§‘ç›®</span>
        </div>
        <input type="text" id="selected-subject" class="form-control" placeholder="é¸æ“‡ç§‘ç›®" readonly>
      </div>
      
      <div class="form-group">
        <label>å¹´ç´š</label>
        <input type="text" id="question-grade" class="form-control" placeholder="ä¾‹å¦‚ï¼šå…­å¹´ç´šã€åœ‹äºŒã€é«˜ä¸‰">
      </div>
      
      <button onclick="submitQuestion()" class="login-box button" style="width:100%;"><i class="fas fa-paper-plane"></i> ç™¼è¡¨å•é¡Œ</button>
    </div>
  </div>

  <!-- ç™¼è¡¨é¡Œç›®æµ®å‹•æŒ‰éˆ• -->
  <button id="floating-action-btn" class="floating-action-btn" style="display:none;" onclick="openQuestionForm()">
    <i class="fas fa-plus"></i>
  </button>

  <!-- é€šçŸ¥å€åŸŸ -->
  <div id="notification" class="notification"></div>

  <script>
    // å…¨åŸŸè®Šæ•¸
    let currentUser = null;
    let isAdmin = false;
    let currentPage = 'dashboard';
    let captchaVerified = false;
    
    // å¯¦æ™‚æ›´æ–°ç›¸é—œè®Šæ•¸
    let updateInterval = null;
    let lastUpdateCheck = 0;
    let isCheckingUpdates = false;

    // å¾Œç«¯æ•¸æ“šï¼ˆå¾ API ç²å–ï¼‰
let backendData = {
  users: {},
  studentData: { primary: [], junior: [], high: [], other: [] },
  pendingData: [],
  announcements: [],
  systemConfig: {},
  friends: {},
  privateMessages: {},
  questions: [],
  chatMessages: []
};

// å¾ API åŠ è¼‰æ•¸æ“š
async function loadBackendData() {
  try {
    const response = await fetch('/api/sync_data');
    const result = await response.json();
    if (result.success) {
      backendData = result.data;
      // è½‰æ› users æ ¼å¼
      if (backendData.users && Array.isArray(backendData.users)) {
        const usersDict = {};
        backendData.users.forEach(user => {
          usersDict[user.username] = user;
        });
        backendData.users = usersDict;
      }
    }
  } catch (error) {
    console.error('åŠ è¼‰æ•¸æ“šå¤±æ•—:', error);
  }
}

    // ä¿å­˜æ•¸æ“šåˆ° API
    function saveBackendData() {
      // ä½¿ç”¨åŒæ­¥æ–¹å¼ï¼Œä¸ç­‰å¾…éŸ¿æ‡‰
      fetch('/api/sync_data', {
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(backendData)
      }).catch(error => {
        console.error('ä¿å­˜æ•¸æ“šå¤±æ•—:', error);
      });
      return true;
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      // ğŸ†• å…ˆåŠ è¼‰æ•¸æ“š
      await loadBackendData();
      
      // æª¢æŸ¥æ˜¯å¦æœ‰é è¨­ç®¡ç†å“¡å¸³è™Ÿ
      if (!backendData.users['Nick20130104']) {
        backendData.users['Nick20130104'] = {
          password: 'Nick20130104',
          name: 'ç³»çµ±ç®¡ç†å“¡',
          school: 'ç®¡ç†å­¸æ ¡',
          email: 'admin@system.com',
          isAdmin: true,
          intro: 'æˆ‘æ˜¯ç³»çµ±ç®¡ç†å“¡ï¼Œè² è²¬ç®¡ç†ç•¢æ¥­è³‡æ–™ç³»çµ±ã€‚',
          anonymous: 'ç®¡ç†å“¡',
          avatar: null,
          personality: 'èªçœŸè² è²¬ã€ç´°å¿ƒåš´è¬¹',
          hobbies: 'ç³»çµ±ç®¡ç†ã€ç¨‹å¼è¨­è¨ˆ',
          likes: 'è§£æ±ºå•é¡Œã€å­¸ç¿’æ–°æŠ€è¡“'
        };
        await saveBackendData();  // ğŸ†• æ·»åŠ  await
      }

      // åˆå§‹åŒ–ç§‘ç›®é¸æ“‡
      initSubjectTags();
    });

    // åˆå§‹åŒ–ç§‘ç›®æ¨™ç±¤
    function initSubjectTags() {
      const tags = document.querySelectorAll('.subject-tag');
      tags.forEach(tag => {
        tag.addEventListener('click', function() {
          tags.forEach(t => t.classList.remove('selected'));
          this.classList.add('selected');
          document.getElementById('selected-subject').value = this.dataset.subject;
        });
      });
    }

    // å¾Œç«¯æ•¸æ“šï¼ˆå¾ API ç²å–ï¼‰
    let backendData = {
      users: {},
      studentData: { primary: [], junior: [], high: [], other: [] },
      pendingData: [],
      announcements: [],
      systemConfig: {},
      friends: {},
      privateMessages: {},
      questions: [],
      chatMessages: []
    };

    // å¾ API åŠ è¼‰æ•¸æ“š
    function loadBackendData() {
      return fetch('/api/sync_data')
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            backendData = result.data;
            // è½‰æ› users æ ¼å¼
            if (backendData.users && Array.isArray(backendData.users)) {
              const usersDict = {};
              backendData.users.forEach(user => {
                usersDict[user.username] = user;
              });
              backendData.users = usersDict;
            }
          }
        })
        .catch(error => {
          console.error('åŠ è¼‰æ•¸æ“šå¤±æ•—:', error);
        });
    }

    // ä¿å­˜æ•¸æ“šåˆ° API
    async function saveBackendData() {
      try {
        const response = await fetch('/api/sync_data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(backendData)
        });
        const result = await response.json();
        return result.success;
      } catch (error) {
        console.error('ä¿å­˜æ•¸æ“šå¤±æ•—:', error);
        return false;
      }
    }

    // é¡¯ç¤ºé€šçŸ¥
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // å­—æ•¸è¨ˆæ•¸å™¨
    function countChars(textareaId, counterId) {
      const textarea = document.getElementById(textareaId);
      const counter = document.getElementById(counterId);
      const count = textarea.value.length;
      counter.textContent = `${count}/${textareaId === 'question-text' ? '150' : '50'}`;
      
      if ((textareaId === 'question-text' && count > 150) || 
          (textareaId !== 'question-text' && count < 50)) {
        counter.classList.add('warning');
      } else {
        counter.classList.remove('warning');
      }
    }

    // é¡¯ç¤ºç®¡ç†å“¡ç™»å…¥
    function showAdminLogin() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('admin-login-screen').style.display = 'flex';
    }

    // éš±è—ç®¡ç†å“¡ç™»å…¥
    function hideAdminLogin() {
      document.getElementById('admin-login-screen').style.display = 'none';
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('captcha-check').checked = false;
      captchaVerified = false;
    }

    // æ©Ÿå™¨äººé©—è­‰åˆ‡æ›
    function toggleCaptcha() {
      const captchaCheck = document.getElementById('captcha-check');
      captchaCheck.checked = !captchaCheck.checked;
      captchaVerified = captchaCheck.checked;
    }

    // ç®¡ç†å“¡ç™»å…¥
    function adminLogin() {
      const username = document.getElementById('admin-username').value;
      const password = document.getElementById('admin-password').value;
      const errorMsg = document.getElementById('admin-error-msg');
      
      if (!username || !password) {
        errorMsg.textContent = 'è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼';
        return;
      }
      
      if (!captchaVerified) {
        errorMsg.textContent = 'è«‹ç¢ºèªæ‚¨ä¸æ˜¯æ©Ÿå™¨äºº';
        return;
      }
      
      const user = backendData.users[username];
      
      if (user && user.password === password && user.isAdmin) {
        currentUser = username;
        isAdmin = true;
        
        document.getElementById('admin-login-screen').style.display = 'none';
        document.getElementById('main-screen').style.display = 'block';
        document.getElementById('current-user-name').textContent = user.name;
        document.getElementById('admin-badge').style.display = 'inline-block';
        document.getElementById('admin-tools').style.display = 'block';
        document.getElementById('review-btn').style.display = 'block';
        document.getElementById('statistics-btn').style.display = 'block';
        
        loadContent('dashboard');
        showNotification(`ç®¡ç†å“¡ ${user.name} æ­¡è¿å›ä¾†ï¼`, 'success');
        
        // é–‹å§‹å¯¦æ™‚æ›´æ–°
        startRealTimeUpdates();
      } else {
        errorMsg.textContent = 'ç®¡ç†å“¡å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
      }
    }

    // ç™»å…¥åŠŸèƒ½
    function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorMsg = document.getElementById('error-msg');
      
      if (!username || !password) {
        errorMsg.textContent = 'è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼';
        return;
      }
      
      const user = backendData.users[username];
      
      if (user && user.password === password) {
        currentUser = username;
        isAdmin = user.isAdmin || false;
        
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-screen').style.display = 'block';
        document.getElementById('current-user-name').textContent = user.name;
        
        if (isAdmin) {
          document.getElementById('admin-badge').style.display = 'inline-block';
          document.getElementById('admin-tools').style.display = 'block';
          document.getElementById('review-btn').style.display = 'block';
          document.getElementById('statistics-btn').style.display = 'block';
        }
        
        loadContent('dashboard');
        showNotification(`æ­¡è¿å›ä¾†ï¼Œ${user.name}ï¼`, 'success');
        
        // é–‹å§‹å¯¦æ™‚æ›´æ–°
        startRealTimeUpdates();
      } else {
        errorMsg.textContent = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
      }
    }

    // å¯¦æ™‚é€šè¨Šä¿®å¾© - é–‹å§‹å¯¦æ™‚æ›´æ–°
    function startRealTimeUpdates() {
      if (updateInterval) clearInterval(updateInterval);
      
      // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡æ›´æ–°ï¼ˆé™ä½é »ç‡ï¼‰
      updateInterval = setInterval(checkForUpdates, 5000);
      console.log('å¯¦æ™‚æ›´æ–°å·²å•Ÿå‹•');
    }

    // æª¢æŸ¥æ›´æ–° - ä¿®å¾©ç‰ˆæœ¬
    async function checkForUpdates() {
      if (!currentUser || isCheckingUpdates) return;
      
      isCheckingUpdates = true;
      try {
        const updates = await simulateCheckUpdates();
        if (updates && !updates.no_updates) {
          handleUpdates(updates);
        }
      } catch (error) {
        console.error('æª¢æŸ¥æ›´æ–°å¤±æ•—:', error);
      } finally {
        isCheckingUpdates = false;
      }
    }

    // æ¨¡æ“¬æª¢æŸ¥æ›´æ–°API - ä¿®å¾©ç‰ˆæœ¬
    function simulateCheckUpdates() {
      return new Promise((resolve) => {
        setTimeout(() => {
          const updates = {
            success: true,
            new_private_messages: checkNewPrivateMessages(),
            pending_friend_requests: checkNewFriendRequests(),
            new_public_messages: checkNewPublicMessages(),
            new_questions: checkNewQuestions(),
            timestamp: Date.now()
          };
          
          // å¦‚æœæ²’æœ‰ä»»ä½•æ›´æ–°ï¼Œæ¨™è¨˜ç‚ºç„¡æ›´æ–°
          if (updates.new_private_messages === 0 && 
              updates.pending_friend_requests === 0 && 
              updates.new_public_messages === 0 && 
              updates.new_questions === 0) {
            updates.no_updates = true;
          }
          
          resolve(updates);
        }, 500);
      });
    }

    // æª¢æŸ¥æ–°ç§è¨Š
    function checkNewPrivateMessages() {
      if (!currentUser) return 0;
      
      const userFriends = backendData.friends[currentUser] || { friends: [] };
      let newMessages = 0;
      
      userFriends.friends?.forEach(friend => {
        const chatKey = getChatKey(currentUser, friend.username);
        const messages = backendData.privateMessages[chatKey] || [];
        
        // è¨ˆç®—æœªè®€æ¶ˆæ¯
        messages.forEach(msg => {
          if (msg.from !== currentUser && !msg.read) {
            newMessages++;
          }
        });
      });
      
      return newMessages;
    }

    // æª¢æŸ¥æ–°å¥½å‹ç”³è«‹
    function checkNewFriendRequests() {
      if (!currentUser) return 0;
      const userData = backendData.friends[currentUser] || {};
      return userData.received_requests?.length || 0;
    }

    // æª¢æŸ¥æ–°å…¬å…±æ¶ˆæ¯ - ä¿®å¾©ç‰ˆæœ¬
    function checkNewPublicMessages() {
      const messages = backendData.chatMessages;
      if (messages.length === 0) return 0;
      
      // æª¢æŸ¥æœ€å¾Œä¸€æ¢æ¶ˆæ¯æ˜¯å¦ä¾†è‡ªå…¶ä»–ç”¨æˆ¶ä¸”æ˜¯æ–°çš„
      const lastMessage = messages[messages.length - 1];
      const isNewMessage = lastMessage.sender !== currentUser && 
                          (!lastMessage.timestamp || lastMessage.timestamp > lastUpdateCheck);
      
      return isNewMessage ? 1 : 0;
    }

    // æª¢æŸ¥æ–°å•é¡Œ - ä¿®å¾©ç‰ˆæœ¬
    function checkNewQuestions() {
      const questions = backendData.questions;
      if (questions.length === 0) return 0;
      
      // æª¢æŸ¥æœ€æ–°å•é¡Œæ˜¯å¦ä¾†è‡ªå…¶ä»–ç”¨æˆ¶ä¸”æ˜¯æ–°çš„
      const latestQuestion = questions[0];
      const isNewQuestion = latestQuestion.author !== currentUser && 
                           (!latestQuestion.created_at || latestQuestion.created_at > lastUpdateCheck);
      
      return isNewQuestion ? 1 : 0;
    }

    // è™•ç†æ›´æ–° - ä¿®å¾©ç‰ˆæœ¬
    function handleUpdates(updateData) {
      if (!updateData.success) return;
      
      // æ›´æ–°æœ€å¾Œæª¢æŸ¥æ™‚é–“
      lastUpdateCheck = updateData.timestamp;
      
      // è™•ç†æ–°ç§è¨Š
      if (updateData.new_private_messages > 0 && currentPage !== 'friends') {
        showNotification(`æ‚¨æœ‰ ${updateData.new_private_messages} æ¢æ–°ç§è¨Š`, 'info');
      }
      
      // è™•ç†å¥½å‹ç”³è«‹
      if (updateData.pending_friend_requests > 0 && currentPage !== 'friends') {
        showNotification(`æ‚¨æœ‰ ${updateData.pending_friend_requests} å€‹å¥½å‹ç”³è«‹`, 'info');
      }
      
      // è™•ç†å…¬å…±èŠå¤©å®¤æ–°æ¶ˆæ¯
      if (updateData.new_public_messages > 0 && currentPage !== 'chat') {
        showNotification('èŠå¤©å®¤æœ‰æ–°æ¶ˆæ¯', 'info');
      }
      
      // è™•ç†æ–°å•é¡Œ - ä¿®å¾©ï¼šç®¡ç†å“¡ä¸æœƒæ”¶åˆ°è‡ªå·±å•é¡Œçš„é€šçŸ¥
      if (updateData.new_questions > 0 && currentPage !== 'questions') {
        showNotification('é¡Œç›®è¨è«–å€æœ‰æ–°å•é¡Œ', 'info');
      }
      
      // å¦‚æœç•¶å‰åœ¨ç›¸é—œé é¢ï¼Œè‡ªå‹•åˆ·æ–°å…§å®¹
      if (currentPage === 'friends') {
        loadFriendRequests();
        loadFriendsList();
        const friendSelect = document.getElementById('private-chat-friend');
        if (friendSelect && friendSelect.value) {
          loadPrivateMessages(friendSelect.value);
        }
      } else if (currentPage === 'chat') {
        loadChat();
      } else if (currentPage === 'questions') {
        loadQuestions();
      }
    }

    // æ›´æ–°æ´»å‹•æ™‚é–“
    function updateActivity(type) {
      console.log(`æ›´æ–°æ´»å‹•æ™‚é–“: ${type}`);
    }

    // ç™»å‡ºåŠŸèƒ½
    function logout() {
      // æ¸…é™¤è¼ªè©¢
      if (updateInterval) clearInterval(updateInterval);
      
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('main-screen').style.display = 'none';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('error-msg').textContent = '';
      document.getElementById('admin-badge').style.display = 'none';
      document.getElementById('admin-tools').style.display = 'none';
      document.getElementById('review-btn').style.display = 'none';
      document.getElementById('statistics-btn').style.display = 'none';
      document.getElementById('floating-action-btn').style.display = 'none';
      currentUser = null;
      isAdmin = false;
    }

    // é¡¯ç¤ºè¨»å†Šé é¢
    function showRegister() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('register-screen').style.display = 'flex';
    }

    // éš±è—è¨»å†Šé é¢
    function hideRegister() {
      document.getElementById('register-screen').style.display = 'none';
      document.getElementById('login-screen').style.display = 'flex';
    }

    // è¨»å†ŠåŠŸèƒ½
    function register() {
      const name = document.getElementById('reg-name').value.trim();
      const school = document.getElementById('reg-school').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value.trim();
      const intro = document.getElementById('reg-intro').value.trim();

      if (!name || !school || !email || !username || !password) {
        showNotification('è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
        return;
      }
      
      if (!email.includes('@gmail.com')) {
        showNotification('è«‹è¼¸å…¥æ­£ç¢ºçš„ Gmail', 'error');
        return;
      }
      
      if (intro.length < 50) {
        showNotification('å€‹äººä»‹ç´¹è‡³å°‘éœ€è¦50å­—', 'error');
        return;
      }
      
      if (backendData.users[username]) {
        showNotification('æ­¤å¸³è™Ÿå·²è¢«ä½¿ç”¨ï¼Œè«‹é¸æ“‡å…¶ä»–å¸³è™Ÿ', 'error');
        return;
      }

      // å„²å­˜ä½¿ç”¨è€…è³‡æ–™
      backendData.users[username] = {
        password: password,
        name: name,
        school: school,
        email: email,
        isAdmin: false,
        intro: intro,
        anonymous: name,
        avatar: null,
        personality: '',
        hobbies: '',
        likes: ''
      };
      
      saveBackendData();
      showNotification('è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥', 'success');
      hideRegister();
    }

    // è¼‰å…¥å…§å®¹
    function loadContent(page) {
      currentPage = page;
      
      // æ›´æ–°å´é‚Šæ¬„æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.side-bar button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      
      // é¡¯ç¤º/éš±è—æµ®å‹•æŒ‰éˆ•
      const fab = document.getElementById('floating-action-btn');
      if (page === 'questions') {
        fab.style.display = 'flex';
      } else {
        fab.style.display = 'none';
      }
      
      const content = document.getElementById('content-area');
      
      switch(page) {
        case 'dashboard':
          renderDashboard();
          break;
        case 'announcements':
          renderAnnouncements();
          break;
        case 'primary':
          renderStudentData('primary', 'åœ‹å°å­¸ç”Ÿ');
          break;
        case 'junior':
          renderStudentData('junior', 'åœ‹ä¸­å­¸ç”Ÿ');
          break;
        case 'high':
          renderStudentData('high', 'é«˜ä¸­å­¸ç”Ÿ');
          break;
        case 'data-entry':
          renderDataForm();
          break;
        case 'other':
          renderStudentData('other', 'å…¶ä»–å¹´ç´š');
          break;
        case 'search':
          renderSearch();
          break;
        case 'review':
          renderReview();
          break;
        case 'statistics':
          renderStatistics();
          break;
        case 'chat':
          renderChat();
          break;
        case 'questions':
          renderQuestions();
          break;
        case 'friends':
          renderFriends();
          break;
        case 'system_config':
          renderSystemConfig();
          break;
      }
    }

    // å„€è¡¨æ¿
    function renderDashboard() {
      const content = document.getElementById('content-area');
      const user = backendData.users[currentUser];
      
      // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
      const totalStudents = 
        backendData.studentData.primary.length + 
        backendData.studentData.junior.length + 
        backendData.studentData.high.length + 
        backendData.studentData.other.length;
      
      content.innerHTML = `
        <div class="content-card">
          <h2><i class="fas fa-tachometer-alt"></i> ç³»çµ±å„€è¡¨æ¿</h2>
          
          <div class="stats-container">
            <div class="stat-card">
              <i class="fas fa-user-graduate"></i>
              <div class="number">${totalStudents}</div>
              <div class="label">ç¸½å­¸ç”Ÿæ•¸</div>
            </div>
            <div class="stat-card">
              <i class="fas fa-child"></i>
              <div class="number">${backendData.studentData.primary.length}</div>
              <div class="label">åœ‹å°å­¸ç”Ÿ</div>
            </div>
            <div class="stat-card">
              <i class="fas fa-user-graduate"></i>
              <div class="number">${backendData.studentData.junior.length}</div>
              <div class="label">åœ‹ä¸­å­¸ç”Ÿ</div>
            </div>
            <div class="stat-card">
              <i class="fas fa-user-tie"></i>
              <div class="number">${backendData.studentData.high.length}</div>
              <div class="label">é«˜ä¸­å­¸ç”Ÿ</div>
            </div>
          </div>
          
          <!-- å€‹äººä»‹ç´¹å€åŸŸ -->
          <div class="personal-intro">
            <h4><i class="fas fa-user"></i> å€‹äººä»‹ç´¹</h4>
            <div class="intro-text">${user.intro || 'æ‚¨é‚„æ²’æœ‰å¡«å¯«å€‹äººä»‹ç´¹ï¼Œè«‹é»æ“Šç·¨è¼¯æŒ‰éˆ•æ–°å¢ã€‚'}</div>
            <button class="edit-intro-btn" onclick="showProfileModal()"><i class="fas fa-edit"></i> ç·¨è¼¯å€‹äººè³‡æ–™</button>
          </div>
          
          <div class="announcement">
            <h3><i class="fas fa-bullhorn"></i> æœ€æ–°å…¬å‘Š</h3>
            ${backendData.announcements.length > 0 ? 
              `<p><strong>${backendData.announcements[0].title}</strong></p>
               <p>${backendData.announcements[0].content}</p>
               <p style="color:#666; font-size:14px;">ç™¼å¸ƒæ™‚é–“: ${backendData.announcements[0].created_time}</p>` :
              '<p>ç›®å‰æ²’æœ‰ä»»ä½•å…¬å‘Š</p>'
            }
            ${isAdmin ? '<p style="color:#ff9800; font-weight:bold;">æ‚¨ç›®å‰ä»¥ç®¡ç†å“¡èº«ä»½ç™»å…¥ï¼Œæ“æœ‰ç³»çµ±ç®¡ç†æ¬Šé™ã€‚</p>' : ''}
          </div>
        </div>
      `;
    }

    // ç³»çµ±å…¬å‘Š
    function renderAnnouncements() {
      const content = document.getElementById('content-area');
      
      let adminControls = '';
      if (isAdmin) {
        adminControls = `
          <div class="content-card">
            <h2><i class="fas fa-edit"></i> ç™¼å¸ƒæ–°å…¬å‘Š</h2>
            <div class="form-group">
              <label for="announcement-title">æ¨™é¡Œ</label>
              <input type="text" id="announcement-title" class="form-control" placeholder="è¼¸å…¥å…¬å‘Šæ¨™é¡Œ">
            </div>
            <div class="form-group">
              <label for="announcement-content">å…§å®¹</label>
              <textarea id="announcement-content" class="form-control" rows="4" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹"></textarea>
            </div>
            <button onclick="publishAnnouncement()" class="login-box button">
              <i class="fas fa-paper-plane"></i> ç™¼å¸ƒå…¬å‘Š
            </button>
          </div>
        `;
      }
      
      content.innerHTML = `
        <div class="content-card">
          <h2><i class="fas fa-bullhorn"></i> ç³»çµ±å…¬å‘Š</h2>
        </div>
        ${adminControls}
        <div class="content-card">
          <h3><i class="fas fa-list"></i> å…¬å‘Šåˆ—è¡¨</h3>
          <div id="announcements-list"></div>
        </div>
      `;
      
      loadAnnouncements();
    }

    // è¼‰å…¥å…¬å‘Š
    function loadAnnouncements() {
      const announcements = backendData.announcements;
      displayAnnouncements(announcements);
    }

    // é¡¯ç¤ºå…¬å‘Š
    function displayAnnouncements(announcements) {
      const container = document.getElementById('announcements-list');
      
      if (announcements.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-bullhorn"></i><h3>ç›®å‰æ²’æœ‰ä»»ä½•å…¬å‘Š</h3><p>ç®¡ç†å“¡ç™¼å¸ƒå…¬å‘Šå¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</p></div>';
        return;
      }
      
      container.innerHTML = announcements.map((announcement, index) => `
        <div class="announcement">
          ${isAdmin ? `
            <div class="announcement-actions">
              <button class="delete-announcement" onclick="deleteAnnouncement(${index})">
                <i class="fas fa-trash"></i> åˆªé™¤
              </button>
            </div>
          ` : ''}
          <h3>${announcement.title}</h3>
          <p>${announcement.content}</p>
          <div style="display:flex; justify-content:space-between; margin-top:10px; color:#666; font-size:14px;">
            <span>ç™¼å¸ƒè€…: ${announcement.author_name}</span>
            <span>æ™‚é–“: ${announcement.created_time}</span>
          </div>
        </div>
      `).join('');
    }

    // ç™¼å¸ƒå…¬å‘Š
    function publishAnnouncement() {
      const title = document.getElementById('announcement-title').value.trim();
      const content = document.getElementById('announcement-content').value.trim();
      
      if (!title || !content) {
        showNotification('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹', 'error');
        return;
      }
      
      const user = backendData.users[currentUser];
      
      const announcement = {
        id: Date.now(),
        title: title,
        content: content,
        author: currentUser,
        author_name: user.name,
        created_at: new Date().toISOString(),
        created_time: new Date().toLocaleString('zh-TW')
      };
      
      backendData.announcements.unshift(announcement);
      saveBackendData();
      
      showNotification('å…¬å‘Šå·²ç™¼å¸ƒ', 'success');
      document.getElementById('announcement-title').value = '';
      document.getElementById('announcement-content').value = '';
      loadAnnouncements();
    }

    // åˆªé™¤å…¬å‘Š
    function deleteAnnouncement(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡å…¬å‘Šå—ï¼Ÿ')) {
        backendData.announcements.splice(index, 1);
        saveBackendData();
        showNotification('å…¬å‘Šå·²åˆªé™¤', 'success');
        loadAnnouncements();
      }
    }

    // è³‡æ–™å¡«å¯«è¡¨å–®
    function renderDataForm() {
      const content = document.getElementById('content-area');
      content.innerHTML = `
        <div class="content-card">
          <h2><i class="fas fa-edit"></i> è³‡æ–™å¡«å¯«</h2>
          <p>è«‹å¡«å¯«ä»¥ä¸‹ç•¢æ¥­ç”Ÿè³‡æ–™ï¼Œæ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«ã€‚</p>
          
          <div class="form-group">
            <label for="form-name">å§“å</label>
            <input type="text" id="form-name" class="form-control" placeholder="è«‹è¼¸å…¥å§“å">
          </div>
          
          <div class="form-group">
            <label for="form-school">å­¸æ ¡</label>
            <input type="text" id="form-school" class="form-control" placeholder="è«‹è¼¸å…¥å­¸æ ¡åç¨±">
          </div>
          
          <div class="form-group">
            <label for="form-gmail">Gmail</label>
            <input type="email" id="form-gmail" class="form-control" placeholder="è«‹è¼¸å…¥Gmail">
          </div>
          
          <div class="form-group">
            <label for="form-level">æ•™è‚²éšæ®µ</label>
            <select id="form-level" class="form-control">
              <option value="primary">åœ‹å°</option>
              <option value="junior">åœ‹ä¸­</option>
              <option value="high">é«˜ä¸­</option>
              <option value="other">å¤§å­¸/ç ”ç©¶æ‰€/åšå£«</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="form-grade">å¹´ç´š</label>
            <input type="text" id="form-grade" class="form-control" placeholder="è«‹è¼¸å…¥å¹´ç´šï¼ˆä¾‹å¦‚ï¼šå…­å¹´ç´šï¼‰">
          </div>
          
          <div class="form-group">
            <label for="form-personality">å€‹æ€§ç‰¹è³ª</label>
            <input type="text" id="form-personality" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ´»æ½‘é–‹æœ—ã€ç´°å¿ƒè² è²¬">
          </div>
          
          <div class="form-group">
            <label for="form-hobbies">èˆˆè¶£æ„›å¥½</label>
            <input type="text" id="form-hobbies" class="form-control" placeholder="ä¾‹å¦‚ï¼šé–±è®€ã€é‹å‹•ã€éŸ³æ¨‚">
          </div>
          
          <div class="form-group">
            <label for="form-likes">å–œæ­¡çš„äº‹ç‰©</label>
            <input type="text" id="form-likes" class="form-control" placeholder="ä¾‹å¦‚ï¼šè²“å’ªã€æ—…è¡Œã€ç¾é£Ÿ">
          </div>
          
          <div class="form-group">
            <label for="form-intro">å€‹äººä»‹ç´¹ (è‡³å°‘50å­—)</label>
            <textarea id="form-intro" class="form-control" rows="4" placeholder="è«‹è©³ç´°ä»‹ç´¹è‡ªå·±..." oninput="countChars('form-intro', 'form-char-count')"></textarea>
            <div id="form-char-count" class="char-counter">0/50</div>
          </div>
          
          <div class="form-group">
            <label for="form-avatar">ä¸Šå‚³é ­åƒ</label>
            <input type="file" id="form-avatar" class="form-control" accept="image/*">
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="agree-checkbox">
            <label for="agree-checkbox">æˆ‘åŒæ„æä¾›æ‰€æœ‰å¡«å¯«è³‡æ–™å…¬é–‹</label>
          </div>
          
          <button onclick="submitFormData()" class="login-box button" style="width:auto; padding:10px 20px;"><i class="fas fa-paper-plane"></i> é€å‡ºè³‡æ–™</button>
        </div>
      `;
    }

    // æäº¤è¡¨å–®è³‡æ–™
    function submitFormData() {
      const name = document.getElementById('form-name').value.trim();
      const school = document.getElementById('form-school').value.trim();
      const gmail = document.getElementById('form-gmail').value.trim();
      const level = document.getElementById('form-level').value;
      const grade = document.getElementById('form-grade').value.trim();
      const personality = document.getElementById('form-personality').value.trim();
      const hobbies = document.getElementById('form-hobbies').value.trim();
      const likes = document.getElementById('form-likes').value.trim();
      const intro = document.getElementById('form-intro').value.trim();
      const agreed = document.getElementById('agree-checkbox').checked;

      if (!name || !school || !gmail || !grade || !personality || !hobbies || !likes) {
        showNotification('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
        return;
      }
      
      if (/\d/.test(name)) {
        showNotification('å§“åä¸èƒ½åŒ…å«æ•¸å­—', 'error');
        return;
      }
      
      if (/\d/.test(school)) {
        showNotification('å­¸æ ¡åç¨±ä¸èƒ½åŒ…å«æ•¸å­—', 'error');
        return;
      }
      
      if (!gmail.endsWith('@gmail.com')) {
        showNotification('è«‹è¼¸å…¥æ­£ç¢ºçš„ Gmail', 'error');
        return;
      }
      
      if (intro.length < 50) {
        showNotification('å€‹äººä»‹ç´¹è‡³å°‘éœ€è¦50å­—', 'error');
        return;
      }
      
      if (!agreed) {
        showNotification('è«‹å‹¾é¸åŒæ„æ›¸', 'error');
        return;
      }

      // è™•ç†é ­åƒä¸Šå‚³
      let avatar = null;
      const avatarUpload = document.getElementById('form-avatar');
      if (avatarUpload.files && avatarUpload.files[0]) {
        const file = avatarUpload.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          avatar = e.target.result;
          completeSubmission();
        };
        reader.readAsDataURL(file);
      } else {
        completeSubmission();
      }

      function completeSubmission() {
        const data = { 
          name, 
          school, 
          gmail, 
          grade, 
          personality,
          hobbies,
          likes,
          intro,
          avatar,
          time: new Date().toLocaleString('zh-TW'),
          status: 'pending',
          submittedBy: currentUser
        };

        // å„²å­˜åˆ°å¾…å¯©æ ¸è³‡æ–™
        backendData.pendingData.push(data);
        saveBackendData();

        showNotification('è³‡æ–™å·²æˆåŠŸé€å‡ºï¼Œç­‰å¾…ç®¡ç†å“¡å¯©æ ¸', 'success');
        renderDataForm();
      }
    }

    // è³‡æ–™æŸ¥è©¢åŠŸèƒ½
    function renderSearch() {
      const content = document.getElementById('content-area');
      content.innerHTML = `
        <div class="content-card">
          <h2><i class="fas fa-search"></i> è³‡æ–™æŸ¥è©¢</h2>
          <p>ä½¿ç”¨ä»¥ä¸‹æ¢ä»¶æŸ¥è©¢å­¸ç”Ÿè³‡æ–™ï¼š</p>
          
          <div class="search-box">
            <div class="search-form">
              <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="search-name" class="form-control" placeholder="è¼¸å…¥å§“å">
              </div>
              
              <div class="form-group">
                <label>å­¸æ ¡</label>
                <input type="text" id="search-school" class="form-control" placeholder="è¼¸å…¥å­¸æ ¡åç¨±">
              </div>
              
              <div class="form-group">
                <label>æ•™è‚²éšæ®µ</label>
                <select id="search-level" class="form-control">
                  <option value="">å…¨éƒ¨</option>
                  <option value="primary">åœ‹å°</option>
                  <option value="junior">åœ‹ä¸­</option>
                  <option value="high">é«˜ä¸­</option>
                  <option value="other">å…¶ä»–</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>å¹´ç´š</label>
                <input type="text" id="search-grade" class="form-control" placeholder="è¼¸å…¥å¹´ç´š">
              </div>
            </div>
            
            <button onclick="performSearch()" class="search-btn" style="margin-top:15px;">
              <i class="fas fa-search"></i> é–‹å§‹æŸ¥è©¢
            </button>
          </div>
          
          <div id="search-results"></div>
        </div>
      `;
    }

    // åŸ·è¡ŒæŸ¥è©¢
    function performSearch() {
      const name = document.getElementById('search-name').value.trim().toLowerCase();
      const school = document.getElementById('search-school').value.trim().toLowerCase();
      const level = document.getElementById('search-level').value;
      const grade = document.getElementById('search-grade').value.trim().toLowerCase();
      
      let results = [];
      
      // æ ¹æ“šé¸æ“‡çš„ç´šåˆ¥æŸ¥è©¢è³‡æ–™
      if (level) {
        results = backendData.studentData[level].filter(item => {
          return (!name || item.name.toLowerCase().includes(name)) &&
                 (!school || item.school.toLowerCase().includes(school)) &&
                 (!grade || item.grade.toLowerCase().includes(grade));
        });
      } else {
        // æŸ¥è©¢æ‰€æœ‰ç´šåˆ¥
        Object.keys(backendData.studentData).forEach(key => {
          const levelResults = backendData.studentData[key].filter(item => {
            return (!name || item.name.toLowerCase().includes(name)) &&
                   (!school || item.school.toLowerCase().includes(school)) &&
                   (!grade || item.grade.toLowerCase().includes(grade));
          });
          results = results.concat(levelResults);
        });
      }
      
      displaySearchResults(results);
    }

    // é¡¯ç¤ºæŸ¥è©¢çµæœ
    function displaySearchResults(results) {
      const resultsContainer = document.getElementById('search-results');
      
      if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="announcement"><p>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</p></div>';
        return;
      }
      
      let resultsHTML = `
        <div class="announcement">
          <h3>æŸ¥è©¢çµæœ (å…± ${results.length} ç­†)</h3>
          <table class="data-table">
            <thead>
              <tr>
                <th>å§“å</th>
                <th>å­¸æ ¡</th>
                <th>Gmail</th>
                <th>å¹´ç´š</th>
                <th>æ•™è‚²éšæ®µ</th>
                <th>å¡«å¯«æ™‚é–“</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      results.forEach(item => {
        // æ‰¾å‡ºé …ç›®å±¬æ–¼å“ªå€‹æ•™è‚²éšæ®µ
        let itemLevel = '';
        Object.keys(backendData.studentData).forEach(level => {
          if (backendData.studentData[level].includes(item)) {
            itemLevel = getLevelName(level);
          }
        });
        
        resultsHTML += `
          <tr>
            <td>${item.name}</td>
            <td>${item.school}</td>
            <td>${item.gmail}</td>
            <td>${item.grade}</td>
            <td>${itemLevel}</td>
            <td>${item.time}</td>
          </tr>
        `;
      });
      
      resultsHTML += `
            </tbody>
          </table>
        </div>
      `;
      
      resultsContainer.innerHTML = resultsHTML;
    }

    // å¯©æ ¸é é¢
    function renderReview() {
      if (!isAdmin) {
        showNotification('æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢', 'error');
        loadContent('dashboard');
        return;
      }
      
      const content = document.getElementById('content-area');
      const pendingData = backendData.pendingData.filter(item => item.status === 'pending');
      const approvedData = backendData.pendingData.filter(item => item.status === 'approved');
      const rejectedData = backendData.pendingData.filter(item => item.status === 'rejected');
      
      content.innerHTML = `
        <div class="content-card">
          <h2><i class="fas fa-clipboard-check"></i> è³‡æ–™å¯©æ ¸</h2>
          <p>å¯©æ ¸ä½¿ç”¨è€…æäº¤çš„å­¸ç”Ÿè³‡æ–™</p>
          
          <div class="filter-tabs">
            <button class="filter-tab active" onclick="showReviewTab('pending')">
              å¾…å¯©æ ¸ <span class="status-badge status-pending">${pendingData.length}</span>
            </button>
            <button class="filter-tab" onclick="showReviewTab('approved')">
              å·²é€šé <span class="status-badge status-approved">${approvedData.length}</span>
            </button>
            <button class="filter-tab" onclick="showReviewTab('rejected')">
              å·²æ‹’çµ• <span class="status-badge status-rejected">${rejectedData.length}</span>
            </button>
          </div>
          
          <div id="review-content">
            ${renderPendingData(pendingData)}
          </div>
        </div>
      `;
    }

    // é¡¯ç¤ºå¯©æ ¸æ¨™ç±¤é 
    function showReviewTab(tab) {
      document.querySelectorAll('.filter-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      
      const reviewContent = document.getElementById('review-content');
      let data = [];
      
      switch(tab) {
        case 'pending':
          data = backendData.pendingData.filter(item => item.status === 'pending');
          reviewContent.innerHTML = renderPendingData(data);
          break;
        case 'approved':
          data = backendData.pendingData.filter(item => item.status === 'approved');
          reviewContent.innerHTML = renderReviewedData(data, 'approved');
          break;
        case 'rejected':
          data = backendData.pendingData.filter(item => item.status === 'rejected');
          reviewContent.innerHTML = renderReviewedData(data, 'rejected');
          break;
      }
    }

    // æ¸²æŸ“å¾…å¯©æ ¸è³‡æ–™
    function renderPendingData(data) {
      if (data.length === 0) {
        return '<div class="announcement"><p>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„è³‡æ–™</p></div>';
      }
      
      return data.map((item, index) => `
        <div class="student-card">
          <div class="student-header">
            <img src="${item.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(item.name)}&background=008B8B&color=fff`}" class="student-avatar">
            <div class="student-basic-info">
              <h3>${item.name} <span class="status-badge status-pending">å¾…å¯©æ ¸</span></h3>
              <p><i class="fas fa-school"></i> ${item.school}</p>
              <p><i class="fas fa-envelope"></i> ${item.gmail}</p>
              <p><i class="fas fa-graduation-cap"></i> ${item.grade}</p>
              <p><i class="fas fa-user"></i> æäº¤è€…: ${backendData.users[item.submittedBy]?.name || 'æœªçŸ¥'}</p>
            </div>
          </div>
          
          <div class="student-details">
            <div class="detail-group">
              <h4><i class="fas fa-heart"></i> å€‹æ€§ç‰¹è³ª</h4>
              <p>${item.personality}</p>
            </div>
            <div class="detail-group">
              <h4><i class="fas fa-star"></i> èˆˆè¶£æ„›å¥½</h4>
              <p>${item.hobbies}</p>
            </div>
            <div class="detail-group">
              <h4><i class="fas fa-thumbs-up"></i> å–œæ­¡çš„äº‹ç‰©</h4>
              <p>${item.likes}</p>
            </div>
          </div>
          
          <div class="student-intro">
            <h4><i class="fas fa-comment"></i> å€‹äººä»‹ç´¹</h4>
            <p>${item.intro}</p>
          </div>
          
          <div class="student-actions">
            <button class="approve-btn" onclick="approveData(${index})">
              <i class="fas fa-check"></i> é€šéå¯©æ ¸
            </button>
            <button class="reject-btn" onclick="rejectData(${index})">
              <i class="fas fa-times"></i> æ‹’çµ•
            </button>
          </div>
        </div>
      `).join('');
    }

    // æ¸²æŸ“å·²å¯©æ ¸è³‡æ–™
    function renderReviewedData(data, status) {
      if (data.length === 0) {
        return '<div class="announcement"><p>ç›®å‰æ²’æœ‰ç›¸é—œè³‡æ–™</p></div>';
      }
      
      const statusText = status === 'approved' ? 'å·²é€šé' : 'å·²æ‹’çµ•';
      const statusClass = status === 'approved' ? 'status-approved' : 'status-rejected';
      
      return data.map((item, index) => `
        <div class="student-card">
          <div class="student-header">
            <img src="${item.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(item.name)}&background=008B8B&color=fff`}" class="student-avatar">
            <div class="student-basic-info">
              <h3>${item.name} <span class="status-badge ${statusClass}">${statusText}</span></h3>
              <p><i class="fas fa-school"></i> ${item.school}</p>
              <p><i class="fas fa-envelope"></i> ${item.gmail}</p>
              <p><i class="fas fa-graduation-cap"></i> ${item.grade}</p>
              <p><i class="fas fa-user"></i> æäº¤è€…: ${backendData.users[item.submittedBy]?.name || 'æœªçŸ¥'}</p>
            </div>
          </div>
          
          <div class="student-details">
            <div class="detail-group">
              <h4><i class="fas fa-heart"></i> å€‹æ€§ç‰¹è³ª</h4>
              <p>${item.personality}</p>
            </div>
            <div class="detail-group">
              <h4><i class="fas fa-star"></i> èˆˆè¶£æ„›å¥½</h4>
              <p>${item.hobbies}</p>
            </div>
            <div class="detail-group">
              <h4><i class="fas fa-thumbs-up"></i> å–œæ­¡çš„äº‹ç‰©</h4>
              <p>${item.likes}</p>
            </div>
          </div>
          
          <div class="student-intro">
            <h4><i class="fas fa-comment"></i> å€‹äººä»‹ç´¹</h4>
            <p>${item.intro}</p>
          </div>
        </div>
      `).join('');
    }

    // é€šéå¯©æ ¸
    function approveData(index) {
      const data = backendData.pendingData[index];
      data.status = 'approved';
      
      // æ ¹æ“šæ•™è‚²éšæ®µæ·»åŠ åˆ°å°æ‡‰çš„è³‡æ–™åº«
      const level = determineLevel(data.grade);
      backendData.studentData[level].push(data);
      
      // å¾å¾…å¯©æ ¸åˆ—è¡¨ä¸­ç§»é™¤
      backendData.pendingData.splice(index, 1);
      
      saveBackendData();
      showNotification('è³‡æ–™å·²é€šéå¯©æ ¸', 'success');
      renderReview(); // é‡æ–°æ¸²æŸ“æ•´å€‹å¯©æ ¸é é¢
    }

    // æ‹’çµ•è³‡æ–™
    function rejectData(index) {
      backendData.pendingData[index].status = 'rejected';
      saveBackendData();
      showNotification('è³‡æ–™å·²æ‹’çµ•', 'success');
      renderReview(); // é‡æ–°æ¸²æŸ“æ•´å€‹å¯©æ ¸é é¢
    }

    // æ ¹æ“šå¹´ç´šåˆ¤æ–·æ•™è‚²éšæ®µ
    function determineLevel(grade) {
      if (grade.includes('å°') || grade.includes('åœ‹å°')) return 'primary';
      if (grade.includes('åœ‹ä¸­')) return 'junior';
      if (grade.includes('é«˜ä¸­')) return 'high';
      return 'other';
    }

    // é¡¯ç¤ºå­¸ç”Ÿè³‡æ–™ï¼ˆç¾åŒ–ç‰ˆï¼‰
    function renderStudentData(level, title) {
      const content = document.getElementById('content-area');
      const data = backendData.studentData[level];
      
      if (data.length === 0) {
        content.innerHTML = `
          <div class="content-card">
            <h2><i class="fas fa-user-graduate"></i> ${title}è³‡æ–™</h2>
            <p>ç›®å‰æ²’æœ‰è³‡æ–™</p>
          </div>
        `;
        return;
      }
      
      content.innerHTML = `
        <div class="content-card">
          <h2><i class="fas fa-user-graduate"></i> ${title}è³‡æ–™</h2>
          <p>å…± ${data.length} ä½å­¸ç”Ÿ</p>
          ${data.map(item => {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯å¥½å‹
            const userFriends = backendData.friends[currentUser] || { friends: [] };
            const isFriend = userFriends.friends && userFriends.friends.some(friend => friend.username === item.submittedBy);
            const hasSentRequest = userFriends.sent_requests && userFriends.sent_requests.some(req => req.to === item.submittedBy);
            
            let friendButton = '';
            if (currentUser && item.submittedBy && item.submittedBy !== currentUser && !isFriend) {
              if (hasSentRequest) {
                friendButton = `<button class="friend-action-btn" style="background:#f39c12;" disabled>
                  <i class="fas fa-clock"></i> ç”³è«‹ä¸­
                </button>`;
              } else {
                friendButton = `<button class="friend-action-btn" onclick="sendFriendRequest('${item.submittedBy}')">
                  <i class="fas fa-user-plus"></i> åŠ å¥½å‹
                </button>`;
              }
            } else if (isFriend) {
              friendButton = `<button class="friend-action-btn" style="background:#2ecc71;" disabled>
                <i class="fas fa-check"></i> å·²æ˜¯å¥½å‹
              </button>`;
            }
            
            return `
              <div class="student-card">
                <div class="student-header">
                  <img src="${item.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(item.name)}&background=008B8B&color=fff`}" class="student-avatar">
                  <div class="student-basic-info">
                    <h3>${item.name}</h3>
                    <p><i class="fas fa-school"></i> ${item.school}</p>
                    <p><i class="fas fa-envelope"></i> ${item.gmail}</p>
                    <p><i class="fas fa-graduation-cap"></i> ${item.grade}</p>
                    ${friendButton}
                  </div>
                </div>
                
                <div class="student-details">
                  <div class="detail-group">
                    <h4><i class="fas fa-heart"></i> å€‹æ€§ç‰¹è³ª</h4>
                    <p>${item.personality}</p>
                  </div>
                  <div class="detail-group">
                    <h4><i class="fas fa-star"></i> èˆˆè¶£æ„›å¥½</h4>
                    <p>${item.hobbies}</p>
                  </div>
                  <div class="detail-group">
                    <h4><i class="fas fa-thumbs-up"></i> å–œæ­¡çš„äº‹ç‰©</h4>
                    <p>${item.likes}</p>
                  </div>
                </div>
                
                <div class="student-intro">
                  <h4><i class="fas fa-comment"></i> å€‹äººä»‹ç´¹</h4>
                  <p>${item.intro}</p>
                </div>
                
                ${isAdmin ? `
                  <div class="student-actions">
                    <button class="delete-btn" onclick="deleteStudentData('${level}', ${backendData.studentData[level].indexOf(item)})">
                      <i class="fas fa-trash"></i> åˆªé™¤
                    </button>
                  </div>
                ` : ''}
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // åˆªé™¤å­¸ç”Ÿè³‡æ–™ï¼ˆåƒ…ç®¡ç†å“¡ï¼‰
    function deleteStudentData(level, index) {
      if (!isAdmin) {
        showNotification('æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ', 'error');
        return;
      }
      
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        backendData.studentData[level].splice(index, 1);
        saveBackendData();
        renderStudentData(level, getLevelName(level));
        showNotification('è³‡æ–™å·²åˆªé™¤', 'success');
      }
    }
    
    // ç²å–ç´šåˆ¥åç¨±
    function getLevelName(level) {
      const names = {
        'primary': 'åœ‹å°å­¸ç”Ÿ',
        'junior': 'åœ‹ä¸­å­¸ç”Ÿ',
        'high': 'é«˜ä¸­å­¸ç”Ÿ',
        'other': 'å…¶ä»–å¹´ç´š'
      };
      return names[level] || 'æœªçŸ¥ç´šåˆ¥';
    }

    // æ•¸æ“šçµ±è¨ˆåŠŸèƒ½ (åƒ…ç®¡ç†å“¡)
    function renderStatistics() {
      if (!isAdmin) {
        showNotification('æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢', 'error');
        loadContent('dashboard');
        return;
      }
      
      const content = document.getElementById('content-area');
      
      // è¨ˆç®—å„ç´šåˆ¥äººæ•¸
      const primaryCount = backendData.studentData.primary.length;
      const juniorCount = backendData.studentData.junior.length;
      const highCount = backendData.studentData.high.length;
      const otherCount = backendData.studentData.other.length;
      const totalCount = primaryCount + juniorCount + highCount + otherCount;
      
      // è¨ˆç®—å­¸æ ¡çµ±è¨ˆ
      const schoolStats = {};
      Object.keys(backendData.studentData).forEach(level => {
        backendData.studentData[level].forEach(student => {
          const school = student.school;
          schoolStats[school] = (schoolStats[school] || 0) + 1;
        });
      });
      
      // è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
      const schoolArray = Object.entries(schoolStats)
        .map(([school, count]) => ({ school, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 10); // å–å‰10å
      
      content.innerHTML = `
        <div class="content-card">
          <h2><i class="fas fa-chart-bar"></i> æ•¸æ“šçµ±è¨ˆ</h2>
          <p>ç³»çµ±è³‡æ–™çµ±è¨ˆåˆ†æ (åƒ…ç®¡ç†å“¡å¯è¦‹)</p>
          
          <div class="stats-container">
            <div class="stat-card">
              <i class="fas fa-users"></i>
              <div class="number">${totalCount}</div>
              <div class="label">ç¸½å­¸ç”Ÿæ•¸</div>
            </div>
            <div class="stat-card">
              <i class="fas fa-child"></i>
              <div class="number">${primaryCount}</div>
              <div class="label">åœ‹å°å­¸ç”Ÿ</div>
            </div>
            <div class="stat-card">
              <i class="fas fa-user-graduate"></i>
              <div class="number">${juniorCount}</div>
              <div class="label">åœ‹ä¸­å­¸ç”Ÿ</div>
            </div>
            <div class="stat-card">
              <i class="fas fa-user-tie"></i>
              <div class="number">${highCount}</div>
              <div class="label">é«˜ä¸­å­¸ç”Ÿ</div>
            </div>
          </div>
          
          <div class="announcement">
            <h3><i class="fas fa-school"></i> å­¸æ ¡çµ±è¨ˆ (å‰10å)</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>æ’å</th>
                  <th>å­¸æ ¡åç¨±</th>
                  <th>å­¸ç”Ÿäººæ•¸</th>
                </tr>
              </thead>
              <tbody>
                ${schoolArray.map((item, index) => `
                  <tr>
                    <td>${index + 1}</td>
                    <td>${item.school}</td>
                    <td>${item.count}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <div class="announcement">
            <h3><i class="fas fa-chart-pie"></i> æ•™è‚²éšæ®µåˆ†ä½ˆ</h3>
            <p>åœ‹å°å­¸ç”Ÿ: ${primaryCount} äºº (${totalCount > 0 ? Math.round(primaryCount/totalCount*100) : 0}%)</p>
            <p>åœ‹ä¸­å­¸ç”Ÿ: ${juniorCount} äºº (${totalCount > 0 ? Math.round(juniorCount/totalCount*100) : 0}%)</p>
            <p>é«˜ä¸­å­¸ç”Ÿ: ${highCount} äºº (${totalCount > 0 ? Math.round(highCount/totalCount*100) : 0}%)</p>
            <p>å…¶ä»–å¹´ç´š: ${otherCount} äºº (${totalCount > 0 ? Math.round(otherCount/totalCount*100) : 0}%)</p>
          </div>
        </div>
      `;
    }

    // èŠå¤©å®¤ - Lineé¢¨æ ¼
    function renderChat() {
      const content = document.getElementById('content-area');
      content.innerHTML = `
        <div class="content-card">
          <h2><i class="fas fa-comments"></i> å…«å¦èŠå¤©å®¤</h2>
          
          <div id="chat-box" style="max-height: 500px; overflow-y: auto; margin: 20px 0; padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #f0f8ff;"></div>
          
          <div class="chat-input">
            <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') sendMessage()">
            <input type="file" id="media-upload" accept="image/*,video/*" style="display:none;">
            <button onclick="document.getElementById('media-upload').click()" class="media-upload-btn">
              <i class="fas fa-paperclip"></i>
            </button>
            <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i> é€å‡º</button>
          </div>
          
          ${isAdmin ? '<p style="color:#ff9800; margin-top:10px;"><i class="fas fa-shield-alt"></i> æ‚¨ä»¥ç®¡ç†å“¡èº«ä»½ç™»å…¥ï¼Œå¯ä»¥åˆªé™¤ä»»ä½•è¨Šæ¯ã€‚</p>' : ''}
        </div>
      `;
      
      // ç›£è½åª’é«”ä¸Šå‚³
      document.getElementById('media-upload').addEventListener('change', handleMediaUpload);
      
      loadChat();
    }

    // è™•ç†åª’é«”ä¸Šå‚³
    function handleMediaUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const mediaType = file.type.startsWith('image/') ? 'image' : 'video';
        sendMessage(null, mediaType, e.target.result);
      };
      reader.readAsDataURL(file);
      
      // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥
      event.target.value = '';
    }

    // è¼‰å…¥èŠå¤©è¨Šæ¯
    function loadChat() {
      const box = document.getElementById('chat-box');
      if (!box) return;
      
      const chatMessages = backendData.chatMessages;
      
      if (chatMessages.length === 0) {
        box.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><h3>é‚„æ²’æœ‰ä»»ä½•è¨Šæ¯</h3><p>å¿«ä¾†ç™¼é€ç¬¬ä¸€æ¢è¨Šæ¯å§ï¼</p></div>';
        return;
      }
      
      box.innerHTML = chatMessages.map((msg, index) => {
        const isCurrentUser = msg.sender === currentUser;
        const user = backendData.users[msg.sender];
        const isMsgAdmin = user && user.isAdmin;
        const displayName = user ? (user.anonymous || user.name) : 'åŒ¿å';
        
        let mediaContent = '';
        if (msg.mediaType && msg.mediaData) {
          if (msg.mediaType === 'image') {
            mediaContent = `<img src="${msg.mediaData}" class="chat-media" alt="å‚³é€çš„åœ–ç‰‡">`;
          } else if (msg.mediaType === 'video') {
            mediaContent = `<video src="${msg.mediaData}" class="chat-media" controls></video>`;
          }
        }
        
        return `
          <div class="chat-message ${isCurrentUser ? 'own' : 'other'} ${isMsgAdmin ? 'admin' : ''}">
            ${!isCurrentUser ? `
              <div class="sender-name">${displayName}${isMsgAdmin ? ' ğŸ‘‘' : ''}</div>
            ` : ''}
            <div>${msg.text || ''}</div>
            ${mediaContent}
            <div class="time">
              ${msg.time}
              ${(isAdmin || isCurrentUser) ? ` <a href="#" onclick="deleteMessage(${index})" style="color:#e74c3c; margin-left:10px;"><i class="fas fa-trash"></i> åˆªé™¤</a>` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      box.scrollTop = box.scrollHeight;
    }

    // ç™¼é€è¨Šæ¯
    function sendMessage(text = null, mediaType = null, mediaData = null) {
      const input = document.getElementById('chat-input');
      const textContent = text || input.value.trim();
      
      if (!textContent && !mediaData) {
        showNotification('è«‹è¼¸å…¥è¨Šæ¯å…§å®¹æˆ–ä¸Šå‚³æª”æ¡ˆ', 'error');
        return;
      }
      
      const user = backendData.users[currentUser];
      
      backendData.chatMessages.push({
        sender: currentUser,
        text: textContent,
        mediaType: mediaType,
        mediaData: mediaData,
        time: new Date().toLocaleString('zh-TW'),
        timestamp: new Date().getTime()
      });
      
      saveBackendData();
      if (input) input.value = '';
      loadChat();
      showNotification('è¨Šæ¯å·²ç™¼é€', 'success');
      
      // é€šçŸ¥å…¶ä»–ç”¨æˆ¶æœ‰æ–°æ¶ˆæ¯
      updateActivity('public_messages');
    }

    // åˆªé™¤è¨Šæ¯
    function deleteMessage(index) {
      if (!isAdmin && backendData.chatMessages[index].sender !== currentUser) {
        showNotification('æ‚¨åªèƒ½åˆªé™¤è‡ªå·±çš„è¨Šæ¯', 'error');
        return;
      }
      
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨Šæ¯å—ï¼Ÿ')) {
        backendData.chatMessages.splice(index, 1);
        saveBackendData();
        loadChat();
        showNotification('è¨Šæ¯å·²åˆªé™¤', 'success');
      }
    }

    // é¡Œç›®è¨è«–å€
    function renderQuestions() {
      const content = document.getElementById('content-area');
      content.innerHTML = `
        <div class="content-card">
          <h2><i class="fas fa-question-circle"></i> é¡Œç›®è¨è«–å€</h2>
          <p>åœ¨é€™è£¡å¯ä»¥æŸ¥çœ‹å’Œè¨è«–å…¶ä»–åŒå­¸æå‡ºçš„å•é¡Œ</p>
        </div>
        <div id="questions-list"></div>
      `;
      
      loadQuestions();
    }

    // è¼‰å…¥é¡Œç›® - ä¿®å¾©ç‰ˆæœ¬ï¼ˆæ·»åŠ é»è®šç‹€æ…‹æª¢æŸ¥ï¼‰
    function loadQuestions() {
      const container = document.getElementById('questions-list');
      const questions = backendData.questions;
      
      if (questions.length === 0) {
        container.innerHTML = `
          <div class="content-card">
            <div class="empty-state">
              <i class="fas fa-question-circle"></i>
              <h3>é‚„æ²’æœ‰ä»»ä½•å•é¡Œ</h3>
              <p>é»æ“Šå³ä¸‹è§’çš„ + æŒ‰éˆ•ä¾†ç™¼è¡¨ç¬¬ä¸€å€‹å•é¡Œå§ï¼</p>
            </div>
          </div>
        `;
        return;
      }
      
      // æŒ‰æ™‚é–“å€’åºæ’åˆ—
      const sortedQuestions = [...questions].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      container.innerHTML = sortedQuestions.map(question => {
        const author = backendData.users[question.author];
        const isAuthor = question.author === currentUser;
        
        // æª¢æŸ¥é»è®šç‹€æ…‹
        const liked = question.liked_by && question.liked_by.includes(currentUser);
        
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯å¥½å‹
        const userFriends = backendData.friends[currentUser] || { friends: [] };
        const isFriend = userFriends.friends && userFriends.friends.some(friend => friend.username === question.author);
        const hasSentRequest = userFriends.sent_requests && userFriends.sent_requests.some(req => req.to === question.author);
        
        let friendButton = '';
        if (currentUser && question.author && question.author !== currentUser && !isFriend) {
          if (hasSentRequest) {
            friendButton = `<button class="action-btn" style="color:#f39c12;" disabled>
              <i class="fas fa-clock"></i> ç”³è«‹ä¸­
            </button>`;
          } else {
            friendButton = `<button class="action-btn" onclick="sendFriendRequest('${question.author}')">
              <i class="fas fa-user-plus"></i> åŠ å¥½å‹
            </button>`;
          }
        }
        
        return `
          <div class="question-card">
            <div class="question-header">
              <img src="${author?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(author?.name || 'åŒ¿å')}&background=3498db&color=fff`}" 
                   class="question-avatar">
              <div class="question-meta">
                <h4>${author?.name || 'åŒ¿å'}</h4>
                <div class="grade-subject">
                  <span>${question.grade} â€¢ ${question.subject}</span>
                  <span style="margin-left: 10px; color: #888;">${question.created_time}</span>
                </div>
              </div>
              ${friendButton}
            </div>
            
            <div class="question-content">
              <div class="question-text">${question.text}</div>
              ${question.image ? `<img src="${question.image}" class="question-image" alt="å•é¡Œåœ–ç‰‡">` : ''}
            </div>
            
            <div class="question-actions">
              <button class="action-btn ${liked ? 'liked' : ''}" onclick="likeQuestion('${question.id}')">
                <i class="fas fa-thumbs-up"></i> è®š (${question.likes || 0})
              </button>
              <button class="action-btn" onclick="focusCommentInput('${question.id}')">
                <i class="fas fa-comment"></i> ç•™è¨€
              </button>
              ${(isAuthor || isAdmin) ? `
                <button class="action-btn" onclick="deleteQuestion('${question.id}')" style="color:#e74c3c;">
                  <i class="fas fa-trash"></i> åˆªé™¤
                </button>
              ` : ''}
            </div>
            
            <div class="comments-section">
              <h5>ç•™è¨€ (${question.comments ? question.comments.length : 0})</h5>
              ${question.comments ? question.comments.map(comment => {
                const commentAuthor = backendData.users[comment.author];
                return `
                  <div class="comment">
                    <div class="comment-header">
                      <img src="${commentAuthor?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(commentAuthor?.name || 'åŒ¿å')}&background=27ae60&color=fff`}" 
                           class="comment-avatar">
                      <strong>${commentAuthor?.name || 'åŒ¿å'}</strong>
                      <span style="margin-left: 10px; color: #888; font-size: 12px;">${comment.time}</span>
                    </div>
                    <div class="comment-content">${comment.text}</div>
                  </div>
                `;
              }).join('') : ''}
              
              <div class="add-comment">
                <input type="text" id="comment-${question.id}" placeholder="è¼¸å…¥ç•™è¨€..." onkeypress="if(event.key==='Enter') addComment('${question.id}')">
                <button onclick="addComment('${question.id}')" class="friend-action-btn chat">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // æ‰“é–‹ç™¼è¡¨é¡Œç›®è¡¨å–®
    function openQuestionForm() {
      document.getElementById('question-form-modal').style.display = 'flex';
    }

    // é—œé–‰ç™¼è¡¨é¡Œç›®è¡¨å–®
    function closeQuestionForm() {
      document.getElementById('question-form-modal').style.display = 'none';
      // é‡ç½®è¡¨å–®
      document.getElementById('question-text').value = '';
      document.getElementById('question-image').value = '';
      document.getElementById('selected-subject').value = '';
      document.getElementById('question-grade').value = '';
      document.querySelectorAll('.subject-tag').forEach(tag => tag.classList.remove('selected'));
    }

    // ç™¼è¡¨å•é¡Œ
    function submitQuestion() {
      const text = document.getElementById('question-text').value.trim();
      const subject = document.getElementById('selected-subject').value;
      const grade = document.getElementById('question-grade').value.trim();
      
      if (!text) {
        showNotification('è«‹è¼¸å…¥å•é¡Œå…§å®¹', 'error');
        return;
      }
      
      if (text.length > 150) {
        showNotification('å•é¡Œå…§å®¹ä¸èƒ½è¶…é150å­—', 'error');
        return;
      }
      
      if (!subject) {
        showNotification('è«‹é¸æ“‡ç§‘ç›®', 'error');
        return;
      }
      
      if (!grade) {
        showNotification('è«‹è¼¸å…¥å¹´ç´š', 'error');
        return;
      }
      
      // è™•ç†åœ–ç‰‡ä¸Šå‚³
      let image = null;
      const imageUpload = document.getElementById('question-image');
      if (imageUpload.files && imageUpload.files[0]) {
        const file = imageUpload.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          image = e.target.result;
          completeQuestionSubmission();
        };
        reader.readAsDataURL(file);
      } else {
        completeQuestionSubmission();
      }

      function completeQuestionSubmission() {
        const question = {
          id: 'q_' + Date.now(),
          text: text,
          subject: subject,
          grade: grade,
          image: image,
          author: currentUser,
          author_name: backendData.users[currentUser].name,
          created_at: new Date().toISOString(),
          created_time: new Date().toLocaleString('zh-TW'),
          likes: 0,
          liked_by: [],  // åˆå§‹åŒ–é»è®šè¨˜éŒ„
          comments: []
        };
        
        backendData.questions.unshift(question);
        saveBackendData();
        
        showNotification('å•é¡Œå·²ç™¼è¡¨', 'success');
        closeQuestionForm();
        loadQuestions();
        
        // é€šçŸ¥å…¶ä»–ç”¨æˆ¶æœ‰æ–°å•é¡Œ
        updateActivity('questions');
      }
    }

    // é»è®šå•é¡Œ - ä¿®å¾©ç‰ˆæœ¬ï¼ˆä¸€å€‹å¸³è™Ÿåªèƒ½é»ä¸€æ¬¡ï¼‰
    function likeQuestion(questionId) {
      const question = backendData.questions.find(q => q.id === questionId);
      if (question) {
        // åˆå§‹åŒ–é»è®šæ•¸æ“š
        if (!question.liked_by) {
          question.liked_by = [];
        }
        
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“é»è®š
        const userIndex = question.liked_by.indexOf(currentUser);
        
        if (userIndex === -1) {
          // é»è®š
          question.liked_by.push(currentUser);
          question.likes = (question.likes || 0) + 1;
          showNotification('å·²é»è®š', 'success');
        } else {
          // å–æ¶ˆé»è®š
          question.liked_by.splice(userIndex, 1);
          question.likes = Math.max(0, (question.likes || 1) - 1);
          showNotification('å·²å–æ¶ˆé»è®š', 'success');
        }
        
        saveBackendData();
        loadQuestions(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°é¡¯ç¤º
      }
    }

    // èšç„¦ç•™è¨€è¼¸å…¥æ¡†
    function focusCommentInput(questionId) {
      const commentInput = document.getElementById(`comment-${questionId}`);
      if (commentInput) {
        commentInput.focus();
      }
    }

    // æ·»åŠ ç•™è¨€
    function addComment(questionId) {
      const commentInput = document.getElementById(`comment-${questionId}`);
      const text = commentInput.value.trim();
      
      if (!text) {
        showNotification('è«‹è¼¸å…¥ç•™è¨€å…§å®¹', 'error');
        return;
      }
      
      const question = backendData.questions.find(q => q.id === questionId);
      if (question) {
        if (!question.comments) question.comments = [];
        
        question.comments.push({
          author: currentUser,
          text: text,
          time: new Date().toLocaleString('zh-TW')
        });
        
        saveBackendData();
        commentInput.value = '';
        loadQuestions();
        showNotification('ç•™è¨€å·²ç™¼å¸ƒ', 'success');
      }
    }

    // åˆªé™¤å•é¡Œ - ä¿®å¾©ç‰ˆæœ¬ï¼ˆç®¡ç†å“¡å¯ä»¥åˆªé™¤ä»»ä½•å•é¡Œï¼‰
    function deleteQuestion(questionId) {
      const question = backendData.questions.find(q => q.id === questionId);
      if (!question) return;
      
      // æª¢æŸ¥æ¬Šé™ï¼šç®¡ç†å“¡æˆ–å•é¡Œä½œè€…
      if (question.author !== currentUser && !isAdmin) {
        showNotification('æ‚¨æ²’æœ‰æ¬Šé™åˆªé™¤æ­¤å•é¡Œ', 'error');
        return;
      }
      
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å•é¡Œå—ï¼Ÿæ‰€æœ‰ç›¸é—œç•™è¨€ä¹Ÿæœƒè¢«åˆªé™¤ã€‚')) {
        backendData.questions = backendData.questions.filter(q => q.id !== questionId);
        saveBackendData();
        loadQuestions();
        showNotification('å•é¡Œå·²åˆªé™¤', 'success');
      }
    }

    // é¡¯ç¤ºå€‹äººç°¡ä»‹å½ˆçª—
    function showProfileModal() {
      const user = backendData.users[currentUser];
      document.getElementById('profile-name').textContent = user.name;
      document.getElementById('profile-school').textContent = user.school;
      document.getElementById('profile-email').textContent = user.email;
      document.getElementById('profile-intro').value = user.intro || '';
      document.getElementById('profile-anonymous').value = user.anonymous || user.name;
      document.getElementById('profile-personality').value = user.personality || '';
      document.getElementById('profile-hobbies').value = user.hobbies || '';
      document.getElementById('profile-likes').value = user.likes || '';
      
      // è¨­å®šé ­åƒ
      const avatarImg = document.getElementById('profile-avatar');
      if (user.avatar) {
        avatarImg.src = user.avatar;
      } else {
        avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=008B8B&color=fff`;
      }
      
      // æ›´æ–°å­—æ•¸è¨ˆæ•¸å™¨
      countChars('profile-intro', 'profile-char-count');
      
      document.getElementById('profile-modal').style.display = 'flex';
    }

    // é—œé–‰å€‹äººç°¡ä»‹å½ˆçª—
    function closeProfileModal() {
      document.getElementById('profile-modal').style.display = 'none';
    }

    // æ›´æ–°å€‹äººè³‡æ–™
    function updateProfile() {
      const user = backendData.users[currentUser];
      const intro = document.getElementById('profile-intro').value;
      const anonymous = document.getElementById('profile-anonymous').value;
      const personality = document.getElementById('profile-personality').value;
      const hobbies = document.getElementById('profile-hobbies').value;
      const likes = document.getElementById('profile-likes').value;
      const currentPassword = document.getElementById('profile-current-password').value;
      const newPassword = document.getElementById('profile-new-password').value;
      const confirmPassword = document.getElementById('profile-confirm-password').value;
      
      if (intro.length < 50) {
        showNotification('å€‹äººä»‹ç´¹è‡³å°‘éœ€è¦50å­—', 'error');
        return;
      }
      
      // æ›´æ–°å€‹äººè³‡æ–™
      user.intro = intro;
      user.anonymous = anonymous;
      user.personality = personality;
      user.hobbies = hobbies;
      user.likes = likes;
      
      // è™•ç†å¯†ç¢¼è®Šæ›´
      if (currentPassword || newPassword || confirmPassword) {
        if (!currentPassword) {
          showNotification('è«‹è¼¸å…¥ç•¶å‰å¯†ç¢¼', 'error');
          return;
        }
        
        if (currentPassword !== user.password) {
          showNotification('ç•¶å‰å¯†ç¢¼ä¸æ­£ç¢º', 'error');
          return;
        }
        
        if (newPassword !== confirmPassword) {
          showNotification('æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´', 'error');
          return;
        }
        
        if (newPassword.length < 6) {
          showNotification('æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6å€‹å­—ç¬¦', 'error');
          return;
        }
        
        user.password = newPassword;
        showNotification('å¯†ç¢¼å·²æˆåŠŸè®Šæ›´', 'success');
        
        // æ¸…ç©ºå¯†ç¢¼æ¬„ä½
        document.getElementById('profile-current-password').value = '';
        document.getElementById('profile-new-password').value = '';
        document.getElementById('profile-confirm-password').value = '';
      }
      
      // è™•ç†é ­åƒä¸Šå‚³
      const avatarUpload = document.getElementById('avatar-upload');
      if (avatarUpload.files && avatarUpload.files[0]) {
        const file = avatarUpload.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
          user.avatar = e.target.result;
          document.getElementById('profile-avatar').src = e.target.result;
          showNotification('é ­åƒå·²æˆåŠŸæ›´æ–°', 'success');
        };
        
        reader.readAsDataURL(file);
      }
      
      saveBackendData();
      showNotification('å€‹äººè³‡æ–™å·²æ›´æ–°', 'success');
      
      // é‡æ–°è¼‰å…¥ç•¶å‰é é¢ä»¥æ›´æ–°é¡¯ç¤º
      loadContent(currentPage);
    }

    // å¥½å‹ç³»çµ± - Instagramé¢¨æ ¼UI
    function renderFriends() {
      const content = document.getElementById('content-area');
      
      content.innerHTML = `
        <div class="friend-section">
          <h2 class="friend-section-title"><i class="fas fa-user-friends"></i> å¥½å‹ç³»çµ±</h2>
          <div class="friend-container">
            <p>ç®¡ç†æ‚¨çš„å¥½å‹å’Œç§è¨Šï¼Œäº«å—å®Œæ•´çš„ç¤¾äº¤é«”é©—ï¼</p>
          </div>
        </div>
        
        <div class="friend-section">
          <h3 class="friend-section-title"><i class="fas fa-user-plus"></i> å¥½å‹ç”³è«‹</h3>
          <div class="friend-container">
            <div id="friend-requests"></div>
          </div>
        </div>
        
        <div class="friend-section">
          <h3 class="friend-section-title"><i class="fas fa-users"></i> æˆ‘çš„å¥½å‹</h3>
          <div class="friend-container">
            <div id="friends-list"></div>
          </div>
        </div>
        
        <div class="friend-section">
          <h3 class="friend-section-title"><i class="fas fa-comments"></i> ç§è¨ŠèŠå¤©</h3>
          <div class="friend-container">
            <div id="private-chat"></div>
          </div>
        </div>
      `;
      
      loadFriendRequests();
      loadFriendsList();
      renderPrivateChat();
    }

    // è¼‰å…¥å¥½å‹ç”³è«‹
    function loadFriendRequests() {
      const userRequests = backendData.friends[currentUser] || { received_requests: [] };
      displayFriendRequests(userRequests.received_requests || []);
    }

    // é¡¯ç¤ºå¥½å‹ç”³è«‹
    function displayFriendRequests(requests) {
      const container = document.getElementById('friend-requests');
      
      if (requests.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>ç›®å‰æ²’æœ‰å¥½å‹ç”³è«‹</h3><p>ç•¶æœ‰äººå‚³é€å¥½å‹ç”³è«‹æ™‚ï¼Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</p></div>';
        return;
      }
      
      container.innerHTML = requests.map(request => {
        const user = backendData.users[request.from];
        return `
          <div class="friend-request-card">
            <div class="friend-header">
              <img src="${user?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(request.from_name)}&background=008B8B&color=fff`}" 
                   class="friend-avatar">
              <div class="friend-info">
                <h4>${request.from_name}</h4>
                <p>æƒ³è¦åŠ æ‚¨ç‚ºå¥½å‹</p>
                <div style="color:#666; font-size:12px;">æ™‚é–“: ${request.sent_time}</div>
              </div>
            </div>
            <div class="request-actions">
              <button class="friend-action-btn chat" onclick="handleFriendRequest('${request.from}', 'accept')">
                <i class="fas fa-check"></i> æ¥å—
              </button>
              <button class="friend-action-btn remove" onclick="handleFriendRequest('${request.from}', 'reject')">
                <i class="fas fa-times"></i> æ‹’çµ•
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // è™•ç†å¥½å‹ç”³è«‹
    function handleFriendRequest(fromUser, action) {
      // å¾æ¥æ”¶æ–¹çš„ç”³è«‹åˆ—è¡¨ä¸­ç§»é™¤
      if (!backendData.friends[currentUser]) {
        backendData.friends[currentUser] = { received_requests: [] };
      }
      backendData.friends[currentUser].received_requests = backendData.friends[currentUser].received_requests.filter(req => req.from !== fromUser);
      
      // å¾ç™¼é€æ–¹çš„å·²ç™¼é€ç”³è«‹ä¸­ç§»é™¤
      if (!backendData.friends[fromUser]) {
        backendData.friends[fromUser] = { sent_requests: [] };
      }
      backendData.friends[fromUser].sent_requests = backendData.friends[fromUser].sent_requests.filter(req => req.to !== currentUser);
      
      if (action === 'accept') {
        // æˆç‚ºå¥½å‹
        const currentUserInfo = backendData.users[currentUser];
        const fromUserInfo = backendData.users[fromUser];
        
        // åˆå§‹åŒ–å¥½å‹åˆ—è¡¨
        if (!backendData.friends[currentUser].friends) backendData.friends[currentUser].friends = [];
        if (!backendData.friends[fromUser].friends) backendData.friends[fromUser].friends = [];
        
        backendData.friends[currentUser].friends.push({
          username: fromUser,
          name: fromUserInfo.name,
          avatar: fromUserInfo.avatar,
          school: fromUserInfo.school,
          became_friends_at: new Date().toISOString()
        });
        
        backendData.friends[fromUser].friends.push({
          username: currentUser,
          name: currentUserInfo.name,
          avatar: currentUserInfo.avatar,
          school: currentUserInfo.school,
          became_friends_at: new Date().toISOString()
        });
        
        showNotification('å¥½å‹ç”³è«‹å·²æ¥å—', 'success');
      } else {
        showNotification('å¥½å‹ç”³è«‹å·²æ‹’çµ•', 'success');
      }
      
      saveBackendData();
      loadFriendRequests();
      loadFriendsList();
    }

    // è¼‰å…¥å¥½å‹åˆ—è¡¨
    function loadFriendsList() {
      const userFriends = backendData.friends[currentUser] || { friends: [] };
      displayFriendsList(userFriends.friends || []);
    }

    // é¡¯ç¤ºå¥½å‹åˆ—è¡¨
    function displayFriendsList(friends) {
      const container = document.getElementById('friends-list');
      
      if (friends.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><h3>æ‚¨é‚„æ²’æœ‰å¥½å‹</h3><p>å¿«å»åŠ å¥½å‹å§ï¼</p></div>';
        return;
      }
      
      container.innerHTML = `
        <div class="friend-list">
          ${friends.map(friend => {
            // éš¨æ©Ÿåœ¨ç·šç‹€æ…‹
            const isOnline = Math.random() > 0.3;
            
            return `
              <div class="friend-card ${isOnline ? 'online' : 'offline'}">
                <div class="friend-header">
                  <img src="${friend.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(friend.name)}&background=008B8B&color=fff`}" 
                       class="friend-avatar">
                  <div class="friend-info">
                    <h4>${friend.name}</h4>
                    <p>${friend.school}</p>
                  </div>
                </div>
                <div class="friend-stats">
                  <span>${isOnline ? 'ğŸŸ¢ åœ¨ç·š' : 'âš« é›¢ç·š'}</span>
                  <span>å¥½å‹ since ${new Date(friend.became_friends_at).toLocaleDateString()}</span>
                </div>
                <div class="friend-actions">
                  <button class="friend-action-btn chat" onclick="startPrivateChat('${friend.username}')">
                    <i class="fas fa-comment"></i> èŠå¤©
                  </button>
                  <button class="friend-action-btn remove" onclick="removeFriend('${friend.username}')">
                    <i class="fas fa-user-minus"></i> åˆªé™¤
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // ç™¼é€å¥½å‹ç”³è«‹
    function sendFriendRequest(targetUser) {
      const currentUserInfo = backendData.users[currentUser];
      const targetUserInfo = backendData.users[targetUser];
      
      // åˆå§‹åŒ–æ•¸æ“š
      if (!backendData.friends[currentUser]) {
        backendData.friends[currentUser] = { sent_requests: [], received_requests: [], friends: [] };
      }
      if (!backendData.friends[targetUser]) {
        backendData.friends[targetUser] = { sent_requests: [], received_requests: [], friends: [] };
      }
      
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“ç™¼é€éç”³è«‹
      const hasSentRequest = backendData.friends[currentUser].sent_requests?.some(req => req.to === targetUser);
      if (hasSentRequest) {
        showNotification('å·²ç¶“ç™¼é€éå¥½å‹ç”³è«‹', 'error');
        return;
      }
      
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯å¥½å‹
      const isFriend = backendData.friends[currentUser].friends?.some(friend => friend.username === targetUser);
      if (isFriend) {
        showNotification('å·²ç¶“æ˜¯å¥½å‹', 'error');
        return;
      }
      
      // ç™¼é€ç”³è«‹
      const requestData = {
        from: currentUser,
        from_name: currentUserInfo.name,
        to: targetUser,
        sent_at: new Date().toISOString(),
        sent_time: new Date().toLocaleString('zh-TW')
      };
      
      // æ·»åŠ åˆ°ç™¼é€æ–¹çš„å·²ç™¼é€ç”³è«‹
      if (!backendData.friends[currentUser].sent_requests) backendData.friends[currentUser].sent_requests = [];
      backendData.friends[currentUser].sent_requests.push({
        to: targetUser,
        to_name: targetUserInfo.name,
        sent_at: new Date().toISOString(),
        sent_time: new Date().toLocaleString('zh-TW')
      });
      
      // æ·»åŠ åˆ°æ¥æ”¶æ–¹çš„æ¥æ”¶ç”³è«‹
      if (!backendData.friends[targetUser].received_requests) backendData.friends[targetUser].received_requests = [];
      backendData.friends[targetUser].received_requests.push(requestData);
      
      saveBackendData();
      showNotification('å¥½å‹ç”³è«‹å·²ç™¼é€', 'success');
      
      // é‡æ–°è¼‰å…¥ç•¶å‰é é¢ä»¥æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      if (currentPage.startsWith('primary') || currentPage.startsWith('junior') || 
          currentPage.startsWith('high') || currentPage.startsWith('other') ||
          currentPage === 'questions') {
        loadContent(currentPage);
      }
    }

    // åˆªé™¤å¥½å‹
    function removeFriend(friendUsername) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å¥½å‹å—ï¼Ÿæ‰€æœ‰èŠå¤©è¨˜éŒ„ä¹Ÿæœƒè¢«åˆªé™¤ã€‚')) {
        return;
      }
      
      // å¾é›™æ–¹å¥½å‹åˆ—è¡¨ä¸­ç§»é™¤
      if (backendData.friends[currentUser] && backendData.friends[currentUser].friends) {
        backendData.friends[currentUser].friends = backendData.friends[currentUser].friends.filter(friend => friend.username !== friendUsername);
      }
      
      if (backendData.friends[friendUsername] && backendData.friends[friendUsername].friends) {
        backendData.friends[friendUsername].friends = backendData.friends[friendUsername].friends.filter(friend => friend.username !== currentUser);
      }
      
      // åˆªé™¤ç§è¨Šè¨˜éŒ„
      const chatKey = getChatKey(currentUser, friendUsername);
      delete backendData.privateMessages[chatKey];
      
      saveBackendData();
      showNotification('å¥½å‹å·²åˆªé™¤', 'success');
      loadFriendsList();
      renderPrivateChat();
    }

    // ç§è¨ŠèŠå¤©
    function renderPrivateChat() {
      const container = document.getElementById('private-chat');
      container.innerHTML = `
        <div class="form-group">
          <label>é¸æ“‡å¥½å‹é€²è¡Œç§è¨Š</label>
          <select id="private-chat-friend" class="form-control" onchange="loadPrivateMessages(this.value)">
            <option value="">è«‹é¸æ“‡å¥½å‹</option>
          </select>
        </div>
        <div id="private-chat-messages" class="private-chat-container"></div>
        <div class="chat-input" id="private-chat-input" style="display:none;">
          <input type="text" id="private-message-input" placeholder="è¼¸å…¥ç§è¨Š..." onkeypress="if(event.key==='Enter') sendPrivateMessage()">
          <input type="file" id="private-media-upload" accept="image/*,video/*" style="display:none;">
          <button onclick="document.getElementById('private-media-upload').click()" class="media-upload-btn">
            <i class="fas fa-paperclip"></i>
          </button>
          <button onclick="sendPrivateMessage()"><i class="fas fa-paper-plane"></i> é€å‡º</button>
        </div>
      `;
      
      // ç›£è½ç§è¨Šåª’é«”ä¸Šå‚³
      document.getElementById('private-media-upload').addEventListener('change', handlePrivateMediaUpload);
      
      loadFriendsForChat();
    }

    // è™•ç†ç§è¨Šåª’é«”ä¸Šå‚³
    function handlePrivateMediaUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const friendUsername = document.getElementById('private-chat-friend').value;
      if (!friendUsername) {
        showNotification('è«‹å…ˆé¸æ“‡å¥½å‹', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const mediaType = file.type.startsWith('image/') ? 'image' : 'video';
        sendPrivateMessage(null, mediaType, e.target.result);
      };
      reader.readAsDataURL(file);
      
      // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥
      event.target.value = '';
    }

    // è¼‰å…¥å¥½å‹åˆ—è¡¨ç”¨æ–¼ç§è¨Š
    function loadFriendsForChat() {
      const userFriends = backendData.friends[currentUser] || { friends: [] };
      const select = document.getElementById('private-chat-friend');
      
      select.innerHTML = '<option value="">è«‹é¸æ“‡å¥½å‹</option>';
      userFriends.friends?.forEach(friend => {
        select.innerHTML += `<option value="${friend.username}">${friend.name}</option>`;
      });
    }

    // é–‹å§‹ç§è¨Š - ä¿®å¾©ç‰ˆæœ¬
    function startPrivateChat(friendUsername) {
      document.getElementById('private-chat-friend').value = friendUsername;
      
      // ç¢ºä¿èŠå¤©é‡‘é‘°å­˜åœ¨
      const chatKey = getChatKey(currentUser, friendUsername);
      if (!backendData.privateMessages[chatKey]) {
        backendData.privateMessages[chatKey] = [];
      }
      
      loadPrivateMessages(friendUsername);
      
      // èšç„¦è¼¸å…¥æ¡†
      setTimeout(() => {
        const input = document.getElementById('private-message-input');
        if (input) input.focus();
      }, 100);
    }

    // è¼‰å…¥ç§è¨Š - ä¿®å¾©ç‰ˆæœ¬
    function loadPrivateMessages(friendUsername) {
      if (!friendUsername) {
        document.getElementById('private-chat-messages').innerHTML = '';
        document.getElementById('private-chat-input').style.display = 'none';
        return;
      }
      
      const chatKey = getChatKey(currentUser, friendUsername);
      const messages = backendData.privateMessages[chatKey] || [];
      
      displayPrivateMessages(messages, friendUsername);
      document.getElementById('private-chat-input').style.display = 'flex';
    }

    // é¡¯ç¤ºç§è¨Š - ä¿®å¾©ç‰ˆæœ¬
    function displayPrivateMessages(messages, friendUsername) {
      const container = document.getElementById('private-chat-messages');
      
      if (messages.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><h3>é‚„æ²’æœ‰ä»»ä½•è¨Šæ¯</h3><p>é–‹å§‹å°è©±å§ï¼</p></div>';
        return;
      }
      
      // æŒ‰æ™‚é–“æ’åº
      const sortedMessages = [...messages].sort((a, b) => new Date(a.timestamp || a.time) - new Date(b.timestamp || b.time));
      
      container.innerHTML = sortedMessages.map(msg => {
        const isOwn = msg.from === currentUser;
        
        let mediaContent = '';
        if (msg.mediaType && msg.mediaData) {
          if (msg.mediaType === 'image') {
            mediaContent = `<img src="${msg.mediaData}" style="max-width:200px; max-height:200px; border-radius:8px; margin:5px 0;" alt="å‚³é€çš„åœ–ç‰‡">`;
          } else if (msg.mediaType === 'video') {
            mediaContent = `<video src="${msg.mediaData}" style="max-width:200px; max-height:200px; border-radius:8px; margin:5px 0;" controls></video>`;
          }
        }
        
        return `
          <div class="private-message ${isOwn ? 'own' : 'other'}">
            ${!isOwn ? `<div class="sender">${msg.from_name}</div>` : ''}
            <div>${msg.text || ''}</div>
            ${mediaContent}
            <div class="time">${msg.time}</div>
          </div>
        `;
      }).join('');
      
      container.scrollTop = container.scrollHeight;
    }

    // çµ±ä¸€çš„èŠå¤©é‡‘é‘°ç”Ÿæˆå‡½æ•¸
    function getChatKey(user1, user2) {
      return [user1, user2].sort().join('_');
    }

    // ç™¼é€ç§è¨Š - ä¿®å¾©ç‰ˆæœ¬
    function sendPrivateMessage(text = null, mediaType = null, mediaData = null) {
      const friendUsername = document.getElementById('private-chat-friend').value;
      const input = document.getElementById('private-message-input');
      const textContent = text || input.value.trim();
      
      if (!friendUsername) {
        showNotification('è«‹é¸æ“‡å¥½å‹', 'error');
        return;
      }
      
      if (!textContent && !mediaData) {
        showNotification('è«‹è¼¸å…¥è¨Šæ¯å…§å®¹æˆ–ä¸Šå‚³æª”æ¡ˆ', 'error');
        return;
      }
      
      // ä½¿ç”¨çµ±ä¸€çš„èŠå¤©é‡‘é‘°
      const chatKey = getChatKey(currentUser, friendUsername);
      
      if (!backendData.privateMessages[chatKey]) {
        backendData.privateMessages[chatKey] = [];
      }
      
      const message = {
        id: 'msg_' + Date.now(),
        from: currentUser,
        from_name: backendData.users[currentUser].name,
        text: textContent,
        mediaType: mediaType,
        mediaData: mediaData,
        time: new Date().toLocaleString('zh-TW'),
        timestamp: new Date().getTime(),
        read: false
      };
      
      backendData.privateMessages[chatKey].push(message);
      
      // åªä¿ç•™æœ€è¿‘200æ¢è¨Šæ¯
      if (backendData.privateMessages[chatKey].length > 200) {
        backendData.privateMessages[chatKey] = backendData.privateMessages[chatKey].slice(-200);
      }
      
      saveBackendData();
      if (input) input.value = '';
      
      // ç«‹å³æ›´æ–°é¡¯ç¤º
      loadPrivateMessages(friendUsername);
      showNotification('ç§è¨Šå·²ç™¼é€', 'success');
      
      // é€šçŸ¥å°æ–¹æœ‰æ–°æ¶ˆæ¯
      updateActivity('private_messages');
    }

    // ç³»çµ±è¨­å®š
    function renderSystemConfig() {
      if (!isAdmin) {
        showNotification('æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢', 'error');
        loadContent('dashboard');
        return;
      }
      
      const config = backendData.systemConfig;
      
      const content = document.getElementById('content-area');
      content.innerHTML = `
        <div class="content-card">
          <h2><i class="fas fa-cogs"></i> ç³»çµ±è¨­å®š</h2>
          <p>ç®¡ç†ç³»çµ±çš„å„ç¨®è¨­å®šé¸é …</p>
          
          <div class="form-group">
            <label for="site-title">ç¶²ç«™æ¨™é¡Œ</label>
            <input type="text" id="site-title" class="form-control" value="${config.siteTitle || 'ç•¢æ¥­è³‡æ–™ç®¡ç†ç³»çµ±'}">
          </div>
          
          <div class="form-group">
            <label for="theme-color">ä¸»é¡Œé¡è‰²</label>
            <input type="color" id="theme-color" class="form-control" value="${config.themeColor || '#008B8B'}">
          </div>
          
          <div class="form-group">
            <label for="welcome-message">æ­¡è¿è¨Šæ¯</label>
            <textarea id="welcome-message" class="form-control" rows="3">${config.welcomeMessage || 'æ­¡è¿ä½¿ç”¨ç•¢æ¥­è³‡æ–™ç®¡ç†ç³»çµ±'}</textarea>
          </div>
          
          <div class="form-group">
            <label for="max-file-size">æœ€å¤§æª”æ¡ˆå¤§å° (MB)</label>
            <input type="number" id="max-file-size" class="form-control" value="${config.maxFileSize || 5}" min="1" max="50">
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="allow-registration" ${config.allowRegistration !== false ? 'checked' : ''}>
            <label for="allow-registration">å…è¨±æ–°ä½¿ç”¨è€…è¨»å†Š</label>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="maintenance-mode" ${config.maintenanceMode ? 'checked' : ''}>
            <label for="maintenance-mode">ç¶­è­·æ¨¡å¼</label>
          </div>
          
          <button onclick="saveSystemConfig()" class="login-box button">
            <i class="fas fa-save"></i> å„²å­˜è¨­å®š
          </button>
        </div>
      `;
    }

    // å„²å­˜ç³»çµ±è¨­å®š
    function saveSystemConfig() {
      backendData.systemConfig = {
        siteTitle: document.getElementById('site-title').value,
        themeColor: document.getElementById('theme-color').value,
        welcomeMessage: document.getElementById('welcome-message').value,
        maxFileSize: parseInt(document.getElementById('max-file-size').value),
        allowRegistration: document.getElementById('allow-registration').checked,
        maintenanceMode: document.getElementById('maintenance-mode').checked
      };
      
      saveBackendData();
      showNotification('ç³»çµ±è¨­å®šå·²æ›´æ–°', 'success');
      
      // æ›´æ–°ç¶²ç«™æ¨™é¡Œ
      document.title = backendData.systemConfig.siteTitle || 'ç•¢æ¥­è³‡æ–™ç®¡ç†ç³»çµ±';
      document.querySelector('.top-bar .title').innerHTML = `<i class="fas fa-graduation-cap"></i> ${backendData.systemConfig.siteTitle || 'ç•¢æ¥­è³‡æ–™ç®¡ç†ç³»çµ±'}`;
    }

    // ç®¡ç†å“¡é¸å–®
    function toggleAdminMenu() {
      const menu = document.getElementById('admin-menu');
      menu.classList.toggle('show');
    }

    // é—œé–‰ç®¡ç†å“¡é¸å–®
    function closeAdminMenu() {
      document.getElementById('admin-menu').classList.remove('show');
    }

    // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰ç®¡ç†å“¡é¸å–®
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.admin-tools')) {
        closeAdminMenu();
      }
    });

    // ç³»çµ±ç·¨è¼¯å™¨
    function openSystemEditor() {
      showNotification('ç³»çµ±ç·¨è¼¯å™¨åŠŸèƒ½é–‹ç™¼ä¸­', 'info');
      closeAdminMenu();
    }

    // ç³»çµ±å‚™ä»½
    function backupSystem() {
      const backupData = {
        users: backendData.users,
        studentData: backendData.studentData,
        pendingData: backendData.pendingData,
        announcements: backendData.announcements,
        systemConfig: backendData.systemConfig,
        friends: backendData.friends,
        privateMessages: backendData.privateMessages,
        questions: backendData.questions,
        chatMessages: backendData.chatMessages,
        timestamp: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `system_backup_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showNotification('ç³»çµ±å‚™ä»½å·²ä¸‹è¼‰', 'success');
      closeAdminMenu();
    }

    // ç³»çµ±é‚„åŸ
    function restoreSystem() {
      showNotification('ç³»çµ±é‚„åŸåŠŸèƒ½é–‹ç™¼ä¸­', 'info');
      closeAdminMenu();
    }
  </script>
</body>
</html>